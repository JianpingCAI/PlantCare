<?xml version="1.0" encoding="utf-8" ?>
<views:ContentPageBase
    x:Class="PlantCare.App.Views.PlantOverviewView"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    xmlns:utils="clr-namespace:PlantCare.App.Utils"
    xmlns:views="clr-namespace:PlantCare.App.Views"
    xmlns:vm="clr-namespace:PlantCare.App.ViewModels"
    x:Name="thisPage"
    x:DataType="vm:PlantListOverviewViewModel">

    <Shell.TitleView>
        <Grid ColumnDefinitions="auto,*" Padding="8,0">
            <Border
                HorizontalOptions="Start"
                Stroke="Transparent"
                StrokeThickness="0"
                VerticalOptions="Center">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="40" />
                </Border.StrokeShape>
                <Image HeightRequest="40" WidthRequest="40" Source="default_plant.png" />
            </Border>

            <HorizontalStackLayout Grid.Column="1" Spacing="4">
                <Label
                    Style="{StaticResource BodyStyle}"
                    Margin="12,0,0,0"
                    HorizontalOptions="Start"
                    Text="{Binding Path=[MyPlants], Source={x:Static utils:LocalizationManager.Instance}}"
                    VerticalTextAlignment="Center" />
                <Label 
                    Style="{StaticResource BodyStyle}" 
                    Text="{Binding Plants.Count, StringFormat='({0})'}"
                    VerticalTextAlignment="Center" />
            </HorizontalStackLayout>
        </Grid>
    </Shell.TitleView>
    
    <ContentPage.Resources>
        <utils:ProgressToColorConverter x:Key="ProgressToColorConverter" />

        <Style x:Key="progressBox" TargetType="BoxView">
            <Setter Property="Color" Value="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource PrimaryDarkText}}" />
            <Setter Property="HeightRequest" Value="5" />
            <Setter Property="VerticalOptions" Value="Center" />
            <Setter Property="HorizontalOptions" Value="End" />
            <Setter Property="WidthRequest" Value="3" />
        </Style>
    </ContentPage.Resources>
    
    <!--  Main Layout  -->
    <Grid Padding="8,4,8,0">

        <Grid HorizontalOptions="FillAndExpand" RowDefinitions="auto,*">
            <!--  Search Bar for quick filtering  -->
            <Border
                BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray900}}"
                Stroke="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray700}}"
                StrokeThickness="1"
                Padding="4,0"
                Margin="0,4,0,8">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="12" />
                </Border.StrokeShape>
                <SearchBar
                    BackgroundColor="Transparent"
                    CancelButtonColor="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource Gray100}}"
                    Placeholder="{Binding Path=[SearchPlantByName], Source={x:Static utils:LocalizationManager.Instance}}"
                    PlaceholderColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}"
                    SearchCommand="{Binding SearchCommand}"
                    Text="{Binding SearchText}"
                    TextColor="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource White}}"
                    VerticalOptions="Center"
                    VerticalTextAlignment="Center" />
            </Border>

            <!--  Plants Collection View  -->
            <RefreshView
                Grid.Row="1"
                Command="{Binding RefreshPlantStatesCommand}"
                IsRefreshing="{Binding IsPlantStatesRefreshing}">
                <CollectionView
                    EmptyView="{Binding Path=[AddMyPlants], Source={x:Static utils:LocalizationManager.Instance}}"
                    ItemsSource="{Binding Plants}"
                    SelectedItem="{Binding SelectedPlant, Mode=TwoWay}"
                    SelectionChangedCommand="{Binding SelectPlantCommand}"
                    SelectionMode="Single">
                    <CollectionView.ItemsLayout>
                        <GridItemsLayout
                            Orientation="Vertical"
                            Span="{Binding Source={x:Reference thisPage}, Path=BindingContext.PhotoSpan}"
                            HorizontalItemSpacing="8"
                            VerticalItemSpacing="8" />
                    </CollectionView.ItemsLayout>

                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="vm:PlantListItemViewModel">
                            <Grid Padding="4" HorizontalOptions="CenterAndExpand">
                                <Border Style="{StaticResource ModernCardStyle}" Padding="0">
                                    <StackLayout Padding="12" Spacing="6">

                                        <!--  Photo  -->
                                        <Border
                                            HorizontalOptions="Center"
                                            Stroke="Transparent"
                                            StrokeThickness="0"
                                            VerticalOptions="Center">
                                            <Border.StrokeShape>
                                                <RoundRectangle CornerRadius="12" />
                                            </Border.StrokeShape>
                                            <Image
                                                Aspect="AspectFill"
                                                HeightRequest="{Binding Source={RelativeSource AncestorType={x:Type vm:PlantListOverviewViewModel}}, Path=PhotoHeight}"
                                                WidthRequest="{Binding Source={RelativeSource AncestorType={x:Type vm:PlantListOverviewViewModel}}, Path=PhotoWidth}"
                                                HorizontalOptions="Center"
                                                Source="{Binding ThumbnailPath}"
                                                VerticalOptions="Center" />
                                        </Border>

                                        <!--  Plant Name  -->
                                        <Label
                                            Style="{StaticResource TitleSmallStyle}"
                                            Text="{Binding Name}"
                                            HorizontalTextAlignment="Center"
                                            LineBreakMode="TailTruncation"
                                            MaxLines="2"
                                            Margin="0,4,0,0" />

                                        <!--  Plant Species (muted)  -->
                                        <Label
                                            Style="{StaticResource BodySmallStyle}"
                                            Text="{Binding Species}"
                                            HorizontalTextAlignment="Center"
                                            LineBreakMode="TailTruncation"
                                            MaxLines="1"
                                            Margin="0,0,0,4" />

                                        <!--  Watering Section  -->
                                        <Grid ColumnDefinitions="auto,*" ColumnSpacing="6" Padding="0" Margin="0,4,0,0">
                                            <Label
                                                Style="{StaticResource TitleStyle}"
                                                Grid.Column="0"
                                                FontFamily="MaterialIconsRegular"
                                                Text="&#xe798;"
                                                TextColor="{Binding WaterState, Converter={StaticResource ProgressToColorConverter}}"
                                                VerticalOptions="Center"
                                                WidthRequest="20" />

                                            <ProgressBar
                                                Grid.Column="1"
                                                HeightRequest="10"
                                                Progress="{Binding WaterState}"
                                                ProgressColor="{Binding WaterState, Converter={StaticResource ProgressToColorConverter}}"
                                                VerticalOptions="Center" />
                                        </Grid>

                                        <!--  Fertilization Section  -->
                                        <Grid ColumnDefinitions="auto,*" ColumnSpacing="6" Padding="0" Margin="0,2,0,0">
                                            <Label
                                                Style="{StaticResource TitleStyle}"
                                                Grid.Column="0"
                                                FontFamily="MaterialIconsRegular"
                                                Text="&#xe761;"
                                                TextColor="{Binding FertilizeState, Converter={StaticResource ProgressToColorConverter}}"
                                                VerticalOptions="Center"
                                                WidthRequest="20" />

                                            <ProgressBar
                                                Grid.Column="1"
                                                HeightRequest="10"
                                                Progress="{Binding FertilizeState}"
                                                ProgressColor="{Binding FertilizeState, Converter={StaticResource ProgressToColorConverter}}"
                                                VerticalOptions="Center" />
                                        </Grid>

                                    </StackLayout>
                                </Border>
                            </Grid>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </RefreshView>
        </Grid>

        <!--  Add Plant Button  -->
        <Button
            Style="{StaticResource DisplayStyle}"
            Margin="0,0,16,80"
            Command="{Binding AddPlantCommand}"
            CornerRadius="60"
            FontFamily="MaterialIconsRegular"
            HorizontalOptions="End"
            Text="&#xe147;"
            VerticalOptions="End"
            WidthRequest="60"
            HeightRequest="60">
            <Button.Shadow>
                <Shadow
                    Brush="{StaticResource Primary}"
                    Opacity="0.4"
                    Radius="16"
                    Offset="0,6" />
            </Button.Shadow>
        </Button>
        
        <Grid
            BackgroundColor="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray500}}"
            IsVisible="{Binding IsLoading}"
            Opacity="0.5">
            <ActivityIndicator
                HorizontalOptions="Center"
                IsRunning="{Binding IsLoading}"
                VerticalOptions="Center" />
        </Grid>
    </Grid>
</views:ContentPageBase>
