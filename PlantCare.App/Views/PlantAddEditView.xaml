<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="PlantCare.App.Views.PlantAddEditView"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:components="clr-namespace:PlantCare.App.Components"
    xmlns:dataAnnotations="clr-namespace:System.ComponentModel.DataAnnotations;assembly=System.ComponentModel.Annotations"
    xmlns:local="clr-namespace:PlantCare.App.Utils"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    xmlns:utils="clr-namespace:PlantCare.App.Utils"
    xmlns:vm="clr-namespace:PlantCare.App.ViewModels"
    Title="{Binding PageTitle}"
    x:DataType="vm:PlantAddEditViewModel">
    <ContentPage.Resources>
        <ResourceDictionary>
            <local:StringToIntConverter x:Key="StringToIntConverter" />
            <toolkit:InvertedBoolConverter x:Key="InvertedBoolConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid Padding="0">
        <ScrollView>
            <VerticalStackLayout Spacing="0">
                <!--  Photo Section  -->
                <Grid Margin="3" BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray950}}">
                    <VerticalStackLayout Spacing="12">
                        <Border
                            HeightRequest="300"
                            HorizontalOptions="Center"
                            MaximumWidthRequest="300"
                            Stroke="{AppThemeBinding Light={StaticResource Gray200},
                                                     Dark={StaticResource Gray800}}"
                            StrokeThickness="2"
                            VerticalOptions="Center"
                            WidthRequest="300">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="150" />
                            </Border.StrokeShape>

                            <Image
                                Aspect="AspectFill"
                                HorizontalOptions="Center"
                                Source="{Binding PhotoPath}"
                                VerticalOptions="Center" />
                        </Border>

                        <!--  Photo Action Buttons  -->
                        <Grid Margin="0,8,0,0" ColumnDefinitions="*,12,*">
                            <Button
                                Margin="10,0"
                                Padding="12,0"
                                Command="{Binding UploadImageCommand}"
                                HeightRequest="44"
                                HorizontalOptions="Fill"
                                Style="{StaticResource OutlineButtonStyle}">
                                <Button.ImageSource>
                                    <FontImageSource
                                        FontFamily="MaterialIconsRegular"
                                        Glyph="&#xe3f4;"
                                        Size="24"
                                        Color="{AppThemeBinding Light={StaticResource Gray900},
                                                                Dark={StaticResource Gray200}}" />
                                </Button.ImageSource>
                                <!--<Button.Text>Gallery</Button.Text>-->
                            </Button>
                            <Button
                                Grid.Column="2"
                                Margin="10,0"
                                Padding="12,0"
                                Command="{Binding TakePhotoCommand}"
                                HeightRequest="44"
                                HorizontalOptions="Fill"
                                Style="{StaticResource OutlineButtonStyle}">
                                <Button.ImageSource>
                                    <FontImageSource
                                        FontFamily="MaterialIconsRegular"
                                        Glyph="&#xe412;"
                                        Size="24"
                                        Color="{AppThemeBinding Light={StaticResource Gray900},
                                                                Dark={StaticResource Gray200}}" />
                                </Button.ImageSource>
                                <!--<Button.Text>Camera</Button.Text>-->
                            </Button>
                        </Grid>
                    </VerticalStackLayout>
                </Grid>

                <!--  Basic Information Section  -->
                <VerticalStackLayout Padding="16,24,16,16" Spacing="16">
                    <Label
                        Margin="0,0,0,8"
                        Style="{StaticResource TitleStyle}"
                        Text="{Binding Path=[BasicInformation], Source={x:Static utils:LocalizationManager.Instance}}" />

                    <!--  Name Field  -->
                    <VerticalStackLayout Spacing="4">
                        <Label Style="{StaticResource LabelStyle}" Text="{Binding Path=[Name], Source={x:Static utils:LocalizationManager.Instance}}" />
                        <Border Padding="12,0" Style="{StaticResource InputBorderStyle}">
                            <Entry Placeholder="Enter plant name" Text="{Binding Name, Mode=TwoWay}" />
                        </Border>
                    </VerticalStackLayout>

                    <!--  Species Field  -->
                    <VerticalStackLayout Spacing="4">
                        <Label Style="{StaticResource LabelStyle}" Text="{Binding Path=[Species], Source={x:Static utils:LocalizationManager.Instance}}" />
                        <Border Padding="12,0" Style="{StaticResource InputBorderStyle}">
                            <Entry Placeholder="Enter species name" Text="{Binding Species, Mode=TwoWay}" />
                        </Border>
                    </VerticalStackLayout>

                    <!--  Age Field  -->
                    <VerticalStackLayout Spacing="4">
                        <Label Style="{StaticResource LabelStyle}" Text="{Binding Path=[Age], Source={x:Static utils:LocalizationManager.Instance}}" />
                        <Grid ColumnDefinitions="*,12,Auto" ColumnSpacing="0">
                            <Border Padding="12,0" Style="{StaticResource InputBorderStyle}">
                                <Entry
                                    HorizontalTextAlignment="Start"
                                    Keyboard="Numeric"
                                    Placeholder="0"
                                    Text="{Binding Age, Mode=TwoWay, Converter={StaticResource StringToIntConverter}}" />
                            </Border>
                            <HorizontalStackLayout Grid.Column="2" Spacing="8">
                                <Button
                                    Padding="0"
                                    Command="{Binding DecrementAgeCommand}"
                                    FontAttributes="Bold"
                                    HeightRequest="44"
                                    Style="{StaticResource OutlineButtonStyle}"
                                    Text="−"
                                    WidthRequest="44" />
                                <Button
                                    Padding="0"
                                    Command="{Binding IncrementAgeCommand}"
                                    FontAttributes="Bold"
                                    HeightRequest="44"
                                    Style="{StaticResource OutlineButtonStyle}"
                                    Text="+"
                                    WidthRequest="44" />
                            </HorizontalStackLayout>
                        </Grid>
                    </VerticalStackLayout>
                </VerticalStackLayout>

                <!--  Divider  -->
                <BoxView
                    Margin="16,8"
                    BackgroundColor="{AppThemeBinding Light={StaticResource Gray200},
                                                      Dark={StaticResource Gray800}}"
                    HeightRequest="1" />

                <!--  Watering Schedule Section  -->
                <VerticalStackLayout Padding="16,16,16,16" Spacing="16">
                    <HorizontalStackLayout Spacing="8">
                        <Label
                            FontFamily="MaterialIconsRegular"
                            Style="{StaticResource DisplaySmallStyle}"
                            Text="&#xe798;"
                            TextColor="{StaticResource Primary}"
                            VerticalOptions="Center" />
                        <Label
                            Style="{StaticResource TitleStyle}"
                            Text="{Binding Path=[WateringSchedule], Source={x:Static utils:LocalizationManager.Instance}}"
                            VerticalOptions="Center" />
                    </HorizontalStackLayout>

                    <!--  Watering Interval  -->
                    <VerticalStackLayout Spacing="8">
                        <Label Style="{StaticResource LabelStyle}" Text="{Binding Path=[WateringInterval], Source={x:Static utils:LocalizationManager.Instance}}" />

                        <Grid
                            ColumnDefinitions="*,*"
                            ColumnSpacing="8"
                            RowDefinitions="Auto,Auto"
                            RowSpacing="8">
                            <!--  Days  -->
                            <VerticalStackLayout Grid.Column="0" Spacing="4">
                                <Label Style="{StaticResource BodySmallStyle}" Text="Days" />
                                <Grid ColumnDefinitions="*,12,Auto" ColumnSpacing="0">
                                    <Border Padding="12,0" Style="{StaticResource InputBorderStyle}">
                                        <Entry
                                            HorizontalTextAlignment="Center"
                                            Keyboard="Numeric"
                                            Placeholder="Days"
                                            Text="{Binding WateringFrequencyDays, Mode=TwoWay, Converter={StaticResource StringToIntConverter}}"
                                            VerticalOptions="Center" />
                                    </Border>
                                    <HorizontalStackLayout Grid.Column="2" Spacing="8">
                                        <Button
                                            Padding="0"
                                            Command="{Binding DecrementWateringDaysCommand}"
                                            FontAttributes="Bold"
                                            HeightRequest="44"
                                            Style="{StaticResource OutlineButtonStyle}"
                                            Text="−"
                                            WidthRequest="44" />
                                        <Button
                                            Padding="0"
                                            Command="{Binding IncrementWateringDaysCommand}"
                                            FontAttributes="Bold"
                                            HeightRequest="44"
                                            Style="{StaticResource OutlineButtonStyle}"
                                            Text="+"
                                            WidthRequest="44" />
                                    </HorizontalStackLayout>
                                </Grid>
                            </VerticalStackLayout>

                            <!--  Hours  -->
                            <VerticalStackLayout Grid.Column="1" Spacing="4">
                                <Label Style="{StaticResource BodySmallStyle}" Text="Hours" />
                                <Grid ColumnDefinitions="*,12,Auto" ColumnSpacing="0">
                                    <Border Padding="12,0" Style="{StaticResource InputBorderStyle}">
                                        <Entry
                                            HorizontalTextAlignment="Center"
                                            Keyboard="Numeric"
                                            Placeholder="Hours"
                                            Text="{Binding WateringFrequencyHours, Mode=TwoWay, Converter={StaticResource StringToIntConverter}}"
                                            VerticalOptions="Center" />
                                    </Border>
                                    <HorizontalStackLayout Grid.Column="2" Spacing="8">
                                        <Button
                                            Padding="0"
                                            Command="{Binding DecrementWateringHoursCommand}"
                                            FontAttributes="Bold"
                                            HeightRequest="44"
                                            Style="{StaticResource OutlineButtonStyle}"
                                            Text="−"
                                            WidthRequest="44" />
                                        <Button
                                            Padding="0"
                                            Command="{Binding IncrementWateringHoursCommand}"
                                            FontAttributes="Bold"
                                            HeightRequest="44"
                                            Style="{StaticResource OutlineButtonStyle}"
                                            Text="+"
                                            WidthRequest="44" />
                                    </HorizontalStackLayout>
                                </Grid>
                            </VerticalStackLayout>
                        </Grid>
                    </VerticalStackLayout>

                    <!--  Last Watering  -->
                    <VerticalStackLayout Spacing="8">
                        <Label Style="{StaticResource LabelStyle}" Text="{Binding Path=[ModifyLastWatering], Source={x:Static utils:LocalizationManager.Instance}}" />

                        <Grid ColumnDefinitions="5*,3*,auto" ColumnSpacing="8">
                            <Border Padding="8,0" Style="{StaticResource InputBorderStyle}">
                                <DatePicker
                                    BackgroundColor="Transparent"
                                    Date="{Binding LastWateredDate, Mode=TwoWay}"
                                    HorizontalOptions="Fill" />
                            </Border>
                            <Border
                                Grid.Column="1"
                                Padding="8,0"
                                Style="{StaticResource InputBorderStyle}">
                                <TimePicker
                                    BackgroundColor="Transparent"
                                    HorizontalOptions="Fill"
                                    Time="{Binding LastWateredTime, Mode=TwoWay}" />
                            </Border>

                            <Button
                                Grid.Column="2"
                                Padding="16,0"
                                Command="{Binding SetCurrentTimeAsLastWateredCommand}"
                                HeightRequest="36"
                                HorizontalOptions="Start"
                                Style="{StaticResource OutlineButtonStyle}"
                                Text="{Binding Path=[SetAsNow], Source={x:Static utils:LocalizationManager.Instance}}" />

                        </Grid>
                    </VerticalStackLayout>
                </VerticalStackLayout>

                <!--  Divider  -->
                <BoxView
                    Margin="16,8"
                    BackgroundColor="{AppThemeBinding Light={StaticResource Gray200},
                                                      Dark={StaticResource Gray800}}"
                    HeightRequest="1" />

                <!--  Fertilization Schedule Section  -->
                <VerticalStackLayout Padding="16,16,16,16" Spacing="16">
                    <HorizontalStackLayout Spacing="8">
                        <Label
                            FontFamily="MaterialIconsRegular"
                            Style="{StaticResource DisplaySmallStyle}"
                            Text="&#xe761;"
                            TextColor="{StaticResource Secondary}"
                            VerticalOptions="Center" />
                        <Label
                            Style="{StaticResource TitleStyle}"
                            Text="{Binding Path=[FertilizationSchedule], Source={x:Static utils:LocalizationManager.Instance}}"
                            VerticalOptions="Center" />
                    </HorizontalStackLayout>

                    <!--  Fertilization Interval  -->
                    <VerticalStackLayout Spacing="8">
                        <Label Style="{StaticResource LabelStyle}" Text="{Binding Path=[FertilizationInterval], Source={x:Static utils:LocalizationManager.Instance}}" />

                        <Grid ColumnDefinitions="*,*" ColumnSpacing="8">
                            <!--  Days  -->
                            <VerticalStackLayout Grid.Column="0" Spacing="4">
                                <Label Style="{StaticResource BodySmallStyle}" Text="Days" />
                                <Grid ColumnDefinitions="*,12,Auto" ColumnSpacing="0">
                                    <Border Padding="12,0" Style="{StaticResource InputBorderStyle}">
                                        <Entry
                                            HorizontalTextAlignment="Center"
                                            Keyboard="Numeric"
                                            Placeholder="Days"
                                            Text="{Binding FertilizationFrequencyDays, Mode=TwoWay, Converter={StaticResource StringToIntConverter}}"
                                            VerticalOptions="Center" />
                                    </Border>
                                    <HorizontalStackLayout Grid.Column="2" Spacing="8">
                                        <Button
                                            Padding="0"
                                            Command="{Binding DecrementFertilizationDaysCommand}"
                                            FontAttributes="Bold"
                                            HeightRequest="44"
                                            Style="{StaticResource OutlineButtonStyle}"
                                            Text="−"
                                            WidthRequest="44" />
                                        <Button
                                            Padding="0"
                                            Command="{Binding IncrementFertilizationDaysCommand}"
                                            FontAttributes="Bold"
                                            HeightRequest="44"
                                            Style="{StaticResource OutlineButtonStyle}"
                                            Text="+"
                                            WidthRequest="44" />
                                    </HorizontalStackLayout>
                                </Grid>
                            </VerticalStackLayout>

                            <!--  Hours  -->
                            <VerticalStackLayout Grid.Column="1" Spacing="4">
                                <Label Style="{StaticResource BodySmallStyle}" Text="Hours" />
                                <Grid ColumnDefinitions="*,12,Auto" ColumnSpacing="0">
                                    <Border Padding="12,0" Style="{StaticResource InputBorderStyle}">
                                        <Entry
                                            HorizontalTextAlignment="Center"
                                            Keyboard="Numeric"
                                            Placeholder="Hours"
                                            Text="{Binding FertilizationFrequencyHours, Mode=TwoWay, Converter={StaticResource StringToIntConverter}}"
                                            VerticalOptions="Center" />
                                    </Border>
                                    <HorizontalStackLayout Grid.Column="2" Spacing="8">
                                        <Button
                                            Padding="0"
                                            Command="{Binding DecrementFertilizationHoursCommand}"
                                            FontAttributes="Bold"
                                            HeightRequest="44"
                                            Style="{StaticResource OutlineButtonStyle}"
                                            Text="−"
                                            WidthRequest="44" />
                                        <Button
                                            Padding="0"
                                            Command="{Binding IncrementFertilizationHoursCommand}"
                                            FontAttributes="Bold"
                                            HeightRequest="44"
                                            Style="{StaticResource OutlineButtonStyle}"
                                            Text="+"
                                            WidthRequest="44" />
                                    </HorizontalStackLayout>
                                </Grid>
                            </VerticalStackLayout>
                        </Grid>
                    </VerticalStackLayout>

                    <!--  Last Fertilization  -->
                    <VerticalStackLayout Spacing="8">
                        <Label Style="{StaticResource LabelStyle}" Text="{Binding Path=[ModifyLastFertilization], Source={x:Static utils:LocalizationManager.Instance}}" />

                        <Grid ColumnDefinitions="5*,3*,auto" ColumnSpacing="8">
                            <Border Padding="8,0" Style="{StaticResource InputBorderStyle}">
                                <DatePicker
                                    BackgroundColor="Transparent"
                                    Date="{Binding LastFertilizationDate, Mode=TwoWay}"
                                    HorizontalOptions="Fill" />
                            </Border>
                            <Border
                                Grid.Column="1"
                                Padding="8,0"
                                Style="{StaticResource InputBorderStyle}">
                                <TimePicker
                                    BackgroundColor="Transparent"
                                    HorizontalOptions="Fill"
                                    Time="{Binding LastFertilizationTime, Mode=TwoWay}" />
                            </Border>

                            <Button
                                Grid.Column="2"
                                Padding="16,0"
                                Command="{Binding SetCurrentTimeAsLastFertilizationCommand}"
                                HeightRequest="36"
                                HorizontalOptions="Start"
                                Style="{StaticResource OutlineButtonStyle}"
                                Text="{Binding Path=[SetAsNow], Source={x:Static utils:LocalizationManager.Instance}}" />
                        </Grid>


                    </VerticalStackLayout>
                </VerticalStackLayout>

                <!--  Divider  -->
                <BoxView
                    Margin="16,8"
                    BackgroundColor="{AppThemeBinding Light={StaticResource Gray200},
                                                      Dark={StaticResource Gray800}}"
                    HeightRequest="1" />

                <!--  Notes Section  -->
                <VerticalStackLayout Padding="16,16,16,24" Spacing="12">
                    <HorizontalStackLayout Spacing="8">
                        <Label
                            FontFamily="MaterialIconsRegular"
                            Style="{StaticResource DisplaySmallStyle}"
                            Text="&#xe24d;"
                            TextColor="{StaticResource Tertiary}"
                            VerticalOptions="Center" />
                        <Label
                            Style="{StaticResource TitleStyle}"
                            Text="{Binding Path=[Notes], Source={x:Static utils:LocalizationManager.Instance}}"
                            VerticalOptions="Center" />
                    </HorizontalStackLayout>

                    <Border
                        Padding="12"
                        HeightRequest="120"
                        Style="{StaticResource InputBorderStyle}">
                        <Editor
                            AutoSize="TextChanges"
                            BackgroundColor="Transparent"
                            Placeholder="Add notes about your plant..."
                            Text="{Binding Notes}" />
                    </Border>
                </VerticalStackLayout>

                <!--  Validation Errors  -->
                <VerticalStackLayout Padding="16,0,16,16" BindableLayout.ItemsSource="{Binding Errors}">
                    <BindableLayout.ItemTemplate>
                        <DataTemplate x:DataType="dataAnnotations:ValidationResult">
                            <Border
                                Margin="0,4"
                                Padding="12"
                                BackgroundColor="{AppThemeBinding Light=#FFF3E0,
                                                                  Dark=#5D4037}"
                                Stroke="{AppThemeBinding Light=#FF6F00,
                                                         Dark=#FF8A65}"
                                StrokeThickness="1">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="8" />
                                </Border.StrokeShape>
                                <HorizontalStackLayout Spacing="8">
                                    <Label
                                        FontFamily="MaterialIconsRegular"
                                        Style="{StaticResource HeadlineSmallStyle}"
                                        Text="&#xe002;"
                                        TextColor="{AppThemeBinding Light=#FF6F00,
                                                                    Dark=#FF8A65}"
                                        VerticalOptions="Center" />
                                    <Label
                                        Style="{StaticResource BodyStyle}"
                                        Text="{Binding ErrorMessage}"
                                        TextColor="{AppThemeBinding Light=#E65100,
                                                                    Dark=#FFAB91}"
                                        VerticalOptions="Center" />
                                </HorizontalStackLayout>
                            </Border>
                        </DataTemplate>
                    </BindableLayout.ItemTemplate>
                </VerticalStackLayout>

                <!--  Save Button  -->
                <Button
                    Margin="16,0,16,32"
                    Command="{Binding SubmitCommand}"
                    FontAttributes="Bold"
                    HeightRequest="52"
                    HorizontalOptions="Fill"
                    IsEnabled="{Binding IsBusy, Converter={StaticResource InvertedBoolConverter}}"
                    Text="{Binding Path=[Save], Source={x:Static utils:LocalizationManager.Instance}}" />
            </VerticalStackLayout>
        </ScrollView>

        <components:LoadingOverlayView IsVisible="{Binding IsLoading}" />
    </Grid>
</ContentPage>
