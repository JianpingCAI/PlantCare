<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="PlantCare.App.Views.PlantAddEditView"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:dataAnnotations="clr-namespace:System.ComponentModel.DataAnnotations;assembly=System.ComponentModel.Annotations"
    xmlns:local="clr-namespace:PlantCare.App.Utils"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    xmlns:utils="clr-namespace:PlantCare.App.Utils"
    xmlns:vm="clr-namespace:PlantCare.App.ViewModels"
    Title="{Binding PageTitle}"
    x:DataType="vm:PlantAddEditViewModel">
    <ContentPage.Resources>
        <ResourceDictionary>
            <local:StringToIntConverter x:Key="StringToIntConverter" />
            <toolkit:InvertedBoolConverter x:Key="InvertedBoolConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>
    
    <Grid Padding="0">
        <ScrollView>
            <VerticalStackLayout Spacing="0">
                <!--  Photo Section  -->
                <Grid BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray950}}" Padding="16,24,16,16">
                    <VerticalStackLayout Spacing="12">
                        <Border
                            HorizontalOptions="Center"
                            Stroke="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray800}}"
                            StrokeThickness="2"
                            VerticalOptions="Center"
                            MaximumWidthRequest="300"
                            HeightRequest="300"
                            WidthRequest="300">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="150" />
                            </Border.StrokeShape>
                            
                            <Image
                                Aspect="AspectFill"
                                HorizontalOptions="Center"
                                Source="{Binding PhotoPath}"
                                VerticalOptions="Center" />
                        </Border>

                        <!--  Photo Action Buttons  -->
                        <Grid ColumnDefinitions="*,12,*" Margin="0,8,0,0">
                            <Button
                                Style="{StaticResource OutlineButtonStyle}"
                                Command="{Binding UploadImageCommand}"
                                HorizontalOptions="Fill"
                                HeightRequest="44"
                                Padding="12,0">
                                <Button.ImageSource>
                                    <FontImageSource
                                        FontFamily="MaterialIconsRegular"
                                        Glyph="&#xe3f4;"
                                        Size="20"
                                        Color="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource Gray200}}" />
                                </Button.ImageSource>
                                <!--<Button.Text>Gallery</Button.Text>-->
                            </Button>
                            <Button
                                Grid.Column="2"
                                Style="{StaticResource OutlineButtonStyle}"
                                Command="{Binding TakePhotoCommand}"
                                HorizontalOptions="Fill"
                                HeightRequest="44"
                                Padding="12,0">
                                <Button.ImageSource>
                                    <FontImageSource
                                        FontFamily="MaterialIconsRegular"
                                        Glyph="&#xe412;"
                                        Size="20"
                                        Color="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource Gray200}}" />
                                </Button.ImageSource>
                                <!--<Button.Text>Camera</Button.Text>-->
                            </Button>
                        </Grid>
                    </VerticalStackLayout>
                </Grid>

                <!--  Basic Information Section  -->
                <VerticalStackLayout Spacing="16" Padding="16,24,16,16">
                    <Label
                        Style="{StaticResource TitleStyle}"
                        Text="Basic Information"
                        Margin="0,0,0,8" />

                    <!--  Name Field  -->
                    <VerticalStackLayout Spacing="4">
                        <Label
                            Style="{StaticResource LabelStyle}"
                            Text="{Binding Path=[Name], Source={x:Static utils:LocalizationManager.Instance}}" />
                        <Border
                            Style="{StaticResource InputBorderStyle}"
                            Padding="12,0">
                            <Entry
                                Text="{Binding Name, Mode=TwoWay}"
                                Placeholder="Enter plant name" />
                        </Border>
                    </VerticalStackLayout>

                    <!--  Species Field  -->
                    <VerticalStackLayout Spacing="4">
                        <Label
                            Style="{StaticResource LabelStyle}"
                            Text="{Binding Path=[Species], Source={x:Static utils:LocalizationManager.Instance}}" />
                        <Border
                            Style="{StaticResource InputBorderStyle}"
                            Padding="12,0">
                            <Entry
                                Text="{Binding Species, Mode=TwoWay}"
                                Placeholder="Enter species name" />
                        </Border>
                    </VerticalStackLayout>

                    <!--  Age Field  -->
                    <VerticalStackLayout Spacing="4">
                        <Label
                            Style="{StaticResource LabelStyle}"
                            Text="{Binding Path=[Age], Source={x:Static utils:LocalizationManager.Instance}}" />
                        <Grid ColumnDefinitions="*,12,Auto" ColumnSpacing="0">
                            <Border
                                Style="{StaticResource InputBorderStyle}"
                                Padding="12,0">
                                <Entry
                                    HorizontalTextAlignment="Start"
                                    Text="{Binding Age, Mode=TwoWay, Converter={StaticResource StringToIntConverter}}"
                                    Placeholder="0"
                                    Keyboard="Numeric" />
                            </Border>
                            <HorizontalStackLayout Grid.Column="2" Spacing="8">
                                <Button
                                    Style="{StaticResource OutlineButtonStyle}"
                                    Text="−"
                                    Command="{Binding DecrementAgeCommand}"
                                    WidthRequest="44"
                                    HeightRequest="44"
                                    FontSize="24"
                                    Padding="0" />
                                <Button
                                    Style="{StaticResource OutlineButtonStyle}"
                                    Text="+"
                                    Command="{Binding IncrementAgeCommand}"
                                    WidthRequest="44"
                                    HeightRequest="44"
                                    FontSize="20"
                                    Padding="0" />
                            </HorizontalStackLayout>
                        </Grid>
                    </VerticalStackLayout>
                </VerticalStackLayout>

                <!--  Divider  -->
                <BoxView HeightRequest="1" BackgroundColor="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray800}}" Margin="16,8" />

                <!--  Watering Schedule Section  -->
                <VerticalStackLayout Spacing="16" Padding="16,16,16,16">
                    <HorizontalStackLayout Spacing="8">
                        <Label
                            FontFamily="MaterialIconsRegular"
                            FontSize="24"
                            Text="&#xe798;"
                            TextColor="{StaticResource Primary}"
                            VerticalOptions="Center" />
                        <Label
                            Style="{StaticResource TitleStyle}"
                            Text="Watering Schedule"
                            VerticalOptions="Center" />
                    </HorizontalStackLayout>

                    <!--  Last Watering  -->
                    <VerticalStackLayout Spacing="8">
                        <Label
                            Style="{StaticResource LabelStyle}"
                            Text="{Binding Path=[LastWatering], Source={x:Static utils:LocalizationManager.Instance}}" />
                        
                        <Grid ColumnDefinitions="*,*" ColumnSpacing="8">
                            <Border Style="{StaticResource InputBorderStyle}" Padding="8,0">
                                <DatePicker 
                                    Date="{Binding LastWateredDate, Mode=TwoWay}" 
                                    BackgroundColor="Transparent"
                                    HorizontalOptions="Fill" />
                            </Border>
                            <Border Grid.Column="1" Style="{StaticResource InputBorderStyle}" Padding="8,0">
                                <TimePicker 
                                    Time="{Binding LastWateredTime, Mode=TwoWay}" 
                                    BackgroundColor="Transparent"
                                    HorizontalOptions="Fill" />
                            </Border>
                        </Grid>
                        
                        <Button
                            Style="{StaticResource OutlineButtonStyle}"
                            Command="{Binding SetCurrentTimeAsLastWateredCommand}"
                            Text="Set to Now"
                            HorizontalOptions="Start"
                            HeightRequest="36"
                            FontSize="14"
                            Padding="16,0" />
                    </VerticalStackLayout>

                    <!--  Watering Interval  -->
                    <VerticalStackLayout Spacing="8">
                        <Label
                            Style="{StaticResource LabelStyle}"
                            Text="{Binding Path=[WateringInterval], Source={x:Static utils:LocalizationManager.Instance}}" />
                        
                        <Grid ColumnDefinitions="*,*" ColumnSpacing="8" RowDefinitions="Auto,Auto" RowSpacing="8">
                            <!--  Days  -->
                            <VerticalStackLayout Grid.Column="0" Spacing="4">
                                <Label Text="Days" Style="{StaticResource BodySmallStyle}" />
                                <Grid ColumnDefinitions="*,12,Auto" ColumnSpacing="0">
                                    <Border Style="{StaticResource InputBorderStyle}" Padding="12,0">
                                        <Entry
                                            HorizontalTextAlignment="Center"
                                            Text="{Binding WateringFrequencyDays, Mode=TwoWay, Converter={StaticResource StringToIntConverter}}"
                                            Placeholder="Days"
                                            Keyboard="Numeric"
                                            VerticalOptions="Center" />
                                    </Border>
                                    <HorizontalStackLayout Grid.Column="2" Spacing="8">
                                        <Button
                                            Style="{StaticResource OutlineButtonStyle}"
                                            Text="−"
                                            Command="{Binding DecrementWateringDaysCommand}"
                                            WidthRequest="44"
                                            HeightRequest="44"
                                            FontSize="24"
                                            Padding="0" />
                                        <Button
                                            Style="{StaticResource OutlineButtonStyle}"
                                            Text="+"
                                            Command="{Binding IncrementWateringDaysCommand}"
                                            WidthRequest="44"
                                            HeightRequest="44"
                                            FontSize="20"
                                            Padding="0" />
                                    </HorizontalStackLayout>
                                </Grid>
                            </VerticalStackLayout>
                            
                            <!--  Hours  -->
                            <VerticalStackLayout Grid.Column="1" Spacing="4">
                                <Label Text="Hours" Style="{StaticResource BodySmallStyle}" />
                                <Grid ColumnDefinitions="*,12,Auto" ColumnSpacing="0">
                                    <Border Style="{StaticResource InputBorderStyle}" Padding="12,0">
                                        <Entry
                                            HorizontalTextAlignment="Center"
                                            Text="{Binding WateringFrequencyHours, Mode=TwoWay, Converter={StaticResource StringToIntConverter}}"
                                            Placeholder="Hours"
                                            Keyboard="Numeric"
                                            VerticalOptions="Center" />
                                    </Border>
                                    <HorizontalStackLayout Grid.Column="2" Spacing="8">
                                        <Button
                                            Style="{StaticResource OutlineButtonStyle}"
                                            Text="−"
                                            Command="{Binding DecrementWateringHoursCommand}"
                                            WidthRequest="44"
                                            HeightRequest="44"
                                            FontSize="24"
                                            Padding="0" />
                                        <Button
                                            Style="{StaticResource OutlineButtonStyle}"
                                            Text="+"
                                            Command="{Binding IncrementWateringHoursCommand}"
                                            WidthRequest="44"
                                            HeightRequest="44"
                                            FontSize="20"
                                            Padding="0" />
                                    </HorizontalStackLayout>
                                </Grid>
                            </VerticalStackLayout>
                        </Grid>
                    </VerticalStackLayout>
                </VerticalStackLayout>

                <!--  Divider  -->
                <BoxView HeightRequest="1" BackgroundColor="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray800}}" Margin="16,8" />

                <!--  Fertilization Schedule Section  -->
                <VerticalStackLayout Spacing="16" Padding="16,16,16,16">
                    <HorizontalStackLayout Spacing="8">
                        <Label
                            FontFamily="MaterialIconsRegular"
                            FontSize="24"
                            Text="&#xe761;"
                            TextColor="{StaticResource Secondary}"
                            VerticalOptions="Center" />
                        <Label
                            Style="{StaticResource TitleStyle}"
                            Text="Fertilization Schedule"
                            VerticalOptions="Center" />
                    </HorizontalStackLayout>

                    <!--  Last Fertilization  -->
                    <VerticalStackLayout Spacing="8">
                        <Label
                            Style="{StaticResource LabelStyle}"
                            Text="{Binding Path=[LastFertilization], Source={x:Static utils:LocalizationManager.Instance}}" />
                        
                        <Grid ColumnDefinitions="*,*" ColumnSpacing="8">
                            <Border Style="{StaticResource InputBorderStyle}" Padding="8,0">
                                <DatePicker 
                                    Date="{Binding LastFertilizationDate, Mode=TwoWay}" 
                                    BackgroundColor="Transparent"
                                    HorizontalOptions="Fill" />
                            </Border>
                            <Border Grid.Column="1" Style="{StaticResource InputBorderStyle}" Padding="8,0">
                                <TimePicker 
                                    Time="{Binding LastFertilizationTime, Mode=TwoWay}" 
                                    BackgroundColor="Transparent"
                                    HorizontalOptions="Fill" />
                            </Border>
                        </Grid>
                        
                        <Button
                            Style="{StaticResource OutlineButtonStyle}"
                            Command="{Binding SetCurrentTimeAsLastFertilizationCommand}"
                            Text="Set to Now"
                            HorizontalOptions="Start"
                            HeightRequest="36"
                            FontSize="14"
                            Padding="16,0" />
                    </VerticalStackLayout>

                    <!--  Fertilization Interval  -->
                    <VerticalStackLayout Spacing="8">
                        <Label
                            Style="{StaticResource LabelStyle}"
                            Text="{Binding Path=[FertilizationInterval], Source={x:Static utils:LocalizationManager.Instance}}" />
                        
                        <Grid ColumnDefinitions="*,*" ColumnSpacing="8">
                            <!--  Days  -->
                            <VerticalStackLayout Grid.Column="0" Spacing="4">
                                <Label Text="Days" Style="{StaticResource BodySmallStyle}" />
                                <Grid ColumnDefinitions="*,12,Auto" ColumnSpacing="0">
                                    <Border Style="{StaticResource InputBorderStyle}" Padding="12,0">
                                        <Entry
                                            HorizontalTextAlignment="Center"
                                            Text="{Binding FertilizationFrequencyDays, Mode=TwoWay, Converter={StaticResource StringToIntConverter}}"
                                            Placeholder="Days"
                                            Keyboard="Numeric"
                                            VerticalOptions="Center" />
                                    </Border>
                                    <HorizontalStackLayout Grid.Column="2" Spacing="8">
                                        <Button
                                            Style="{StaticResource OutlineButtonStyle}"
                                            Text="−"
                                            Command="{Binding DecrementFertilizationDaysCommand}"
                                            WidthRequest="44"
                                            HeightRequest="44"
                                            FontSize="24"
                                            Padding="0" />
                                        <Button
                                            Style="{StaticResource OutlineButtonStyle}"
                                            Text="+"
                                            Command="{Binding IncrementFertilizationDaysCommand}"
                                            WidthRequest="44"
                                            HeightRequest="44"
                                            FontSize="20"
                                            Padding="0" />
                                    </HorizontalStackLayout>
                                </Grid>
                            </VerticalStackLayout>
                            
                            <!--  Hours  -->
                            <VerticalStackLayout Grid.Column="1" Spacing="4">
                                <Label Text="Hours" Style="{StaticResource BodySmallStyle}" />
                                <Grid ColumnDefinitions="*,12,Auto" ColumnSpacing="0">
                                    <Border Style="{StaticResource InputBorderStyle}" Padding="12,0">
                                        <Entry
                                            HorizontalTextAlignment="Center"
                                            Text="{Binding FertilizationFrequencyHours, Mode=TwoWay, Converter={StaticResource StringToIntConverter}}"
                                            Placeholder="Hours"
                                            Keyboard="Numeric"
                                            VerticalOptions="Center" />
                                    </Border>
                                    <HorizontalStackLayout Grid.Column="2" Spacing="8">
                                        <Button
                                            Style="{StaticResource OutlineButtonStyle}"
                                            Text="−"
                                            Command="{Binding DecrementFertilizationHoursCommand}"
                                            WidthRequest="44"
                                            HeightRequest="44"
                                            FontSize="24"
                                            Padding="0" />
                                        <Button
                                            Style="{StaticResource OutlineButtonStyle}"
                                            Text="+"
                                            Command="{Binding IncrementFertilizationHoursCommand}"
                                            WidthRequest="44"
                                            HeightRequest="44"
                                            FontSize="20"
                                            Padding="0" />
                                    </HorizontalStackLayout>
                                </Grid>
                            </VerticalStackLayout>
                        </Grid>
                    </VerticalStackLayout>
                </VerticalStackLayout>

                <!--  Divider  -->
                <BoxView HeightRequest="1" BackgroundColor="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray800}}" Margin="16,8" />

                <!--  Notes Section  -->
                <VerticalStackLayout Spacing="12" Padding="16,16,16,24">
                    <HorizontalStackLayout Spacing="8">
                        <Label
                            FontFamily="MaterialIconsRegular"
                            FontSize="24"
                            Text="&#xe24d;"
                            TextColor="{StaticResource Tertiary}"
                            VerticalOptions="Center" />
                        <Label
                            Style="{StaticResource TitleStyle}"
                            Text="{Binding Path=[Notes], Source={x:Static utils:LocalizationManager.Instance}}"
                            VerticalOptions="Center" />
                    </HorizontalStackLayout>

                    <Border
                        Style="{StaticResource InputBorderStyle}"
                        Padding="12"
                        HeightRequest="120">
                        <Editor 
                            Text="{Binding Notes}"
                            Placeholder="Add notes about your plant..."
                            BackgroundColor="Transparent"
                            AutoSize="TextChanges" />
                    </Border>
                </VerticalStackLayout>

                <!--  Validation Errors  -->
                <VerticalStackLayout Padding="16,0,16,16" BindableLayout.ItemsSource="{Binding Errors}">
                    <BindableLayout.ItemTemplate>
                        <DataTemplate x:DataType="dataAnnotations:ValidationResult">
                            <Border
                                BackgroundColor="{AppThemeBinding Light=#FFF3E0, Dark=#5D4037}"
                                Stroke="{AppThemeBinding Light=#FF6F00, Dark=#FF8A65}"
                                StrokeThickness="1"
                                Padding="12"
                                Margin="0,4">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="8" />
                                </Border.StrokeShape>
                                <HorizontalStackLayout Spacing="8">
                                    <Label 
                                        FontFamily="MaterialIconsRegular"
                                        Text="&#xe002;"
                                        FontSize="20"
                                        TextColor="{AppThemeBinding Light=#FF6F00, Dark=#FF8A65}"
                                        VerticalOptions="Center" />
                                    <Label 
                                        Text="{Binding ErrorMessage}"
                                        TextColor="{AppThemeBinding Light=#E65100, Dark=#FFAB91}"
                                        VerticalOptions="Center" />
                                </HorizontalStackLayout>
                            </Border>
                        </DataTemplate>
                    </BindableLayout.ItemTemplate>
                </VerticalStackLayout>

                <!--  Save Button  -->
                <Button
                    Command="{Binding SubmitCommand}"
                    HorizontalOptions="Fill"
                    IsEnabled="{Binding IsBusy, Converter={StaticResource InvertedBoolConverter}}"
                    HeightRequest="52"
                    Margin="16,0,16,32"
                    FontSize="16"
                    FontAttributes="Bold"
                    Text="{Binding Path=[Save], Source={x:Static utils:LocalizationManager.Instance}}" />
            </VerticalStackLayout>
        </ScrollView>
        
        <Grid
            BackgroundColor="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray500}}"
            IsVisible="{Binding IsLoading}"
            Opacity="0.5">
            <ActivityIndicator
                HorizontalOptions="Center"
                IsRunning="{Binding IsLoading}"
                VerticalOptions="Center" />
        </Grid>
    </Grid>
</ContentPage>
