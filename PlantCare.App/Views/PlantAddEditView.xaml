<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="PlantCare.App.Views.PlantAddEditView"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:components="clr-namespace:PlantCare.App.Components"
    xmlns:dataAnnotations="clr-namespace:System.ComponentModel.DataAnnotations;assembly=System.ComponentModel.Annotations"
    xmlns:local="clr-namespace:PlantCare.App.Utils"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    xmlns:utils="clr-namespace:PlantCare.App.Utils"
    xmlns:vm="clr-namespace:PlantCare.App.ViewModels"
    x:DataType="vm:PlantAddEditViewModel">
    
    <Shell.TitleView>
        <Grid
            Padding="12,0,8,0"
            ColumnDefinitions="auto,*"
            ColumnSpacing="12">
            <!--  Icon  -->
            <Border
                HorizontalOptions="Start"
                Stroke="Transparent"
                StrokeThickness="0"
                VerticalOptions="Center">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="12" />
                </Border.StrokeShape>
                <Border.Shadow>
                    <Shadow
                        Brush="{StaticResource Primary}"
                        Opacity="0.15"
                        Radius="8"
                        Offset="0,2" />
                </Border.Shadow>
                <Image
                    HeightRequest="44"
                    Source="default_plant.png"
                    WidthRequest="44" />
            </Border>

            <!--  Title  -->
            <Label
                Grid.Column="1"
                Style="{StaticResource TitleSmallStyle}"
                Text="{Binding PageTitle}"
                VerticalOptions="Center"
                VerticalTextAlignment="Center" />
        </Grid>
    </Shell.TitleView>
    
    <ContentPage.Resources>
        <ResourceDictionary>
            <local:StringToIntConverter x:Key="StringToIntConverter" />
            <toolkit:InvertedBoolConverter x:Key="InvertedBoolConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid Padding="16">
        <ScrollView>
            <VerticalStackLayout Spacing="20">
                <!--  Photo Section with Floating Action Buttons  -->
                <Grid Margin="0">
                    <Border
                        HeightRequest="300"
                        HorizontalOptions="Center"
                        MaximumWidthRequest="300"
                        Stroke="{AppThemeBinding Light={StaticResource Gray200},
                                                 Dark={StaticResource Gray800}}"
                        StrokeThickness="2"
                        Style="{StaticResource ModernCardStyle}"
                        VerticalOptions="Center"
                        WidthRequest="300">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="150" />
                        </Border.StrokeShape>

                        <Image
                            Aspect="AspectFill"
                            HorizontalOptions="Center"
                            Source="{Binding PhotoPath}"
                            VerticalOptions="Center" />
                    </Border>

                    <!--  Gallery Button (Left Bottom Corner)  -->
                    <Button
                        Margin="24,0,0,5"
                        Command="{Binding UploadImageCommand}"
                        HorizontalOptions="Start"
                        Style="{StaticResource FabButtonStyle}"
                        VerticalOptions="End">
                        <Button.ImageSource>
                            <FontImageSource
                                FontFamily="MaterialIconsRegular"
                                Glyph="&#xe3f4;"
                                Size="24"
                                Color="White" />
                        </Button.ImageSource>
                    </Button>

                    <!--  Camera Button (Right Bottom Corner)  -->
                    <Button
                        Margin="0,0,24,5"
                        Command="{Binding TakePhotoCommand}"
                        HorizontalOptions="End"
                        Style="{StaticResource FabButtonStyle}"
                        VerticalOptions="End">
                        <Button.ImageSource>
                            <FontImageSource
                                FontFamily="MaterialIconsRegular"
                                Glyph="&#xe412;"
                                Size="24"
                                Color="White" />
                        </Button.ImageSource>
                    </Button>
                </Grid>

                <!--  Basic Information Card  -->
                <Border Padding="16" Style="{StaticResource ModernCardStyle}">
                    <VerticalStackLayout Spacing="16">
                        <Label Style="{StaticResource TitleSmallStyle}" Text="{Binding Path=[BasicInformation], Source={x:Static utils:LocalizationManager.Instance}}" />

                        <!--  Name Field  -->
                        <VerticalStackLayout Spacing="8">
                            <Label Style="{StaticResource LabelStyle}" Text="{Binding Path=[Name], Source={x:Static utils:LocalizationManager.Instance}}" />
                            <Border Padding="12,0" Style="{StaticResource InputBorderStyle}">
                                <Entry Placeholder="Enter plant name" Text="{Binding Name, Mode=TwoWay}" />
                            </Border>
                        </VerticalStackLayout>

                        <!--  Species Field  -->
                        <VerticalStackLayout Spacing="8">
                            <Label Style="{StaticResource LabelStyle}" Text="{Binding Path=[Species], Source={x:Static utils:LocalizationManager.Instance}}" />
                            <Border Padding="12,0" Style="{StaticResource InputBorderStyle}">
                                <Entry Placeholder="Enter species name" Text="{Binding Species, Mode=TwoWay}" />
                            </Border>
                        </VerticalStackLayout>

                        <!--  Age Field  -->
                        <VerticalStackLayout Spacing="8">
                            <Label Style="{StaticResource LabelStyle}" Text="{Binding Path=[Age], Source={x:Static utils:LocalizationManager.Instance}}" />
                            <Grid ColumnDefinitions="*,Auto">
                                <Border Padding="12,0" Style="{StaticResource InputBorderStyle}">
                                    <Entry
                                        HorizontalTextAlignment="Start"
                                        Keyboard="Numeric"
                                        Placeholder="0"
                                        Text="{Binding Age, Mode=TwoWay, Converter={StaticResource StringToIntConverter}}" />
                                </Border>
                                <HorizontalStackLayout
                                    Grid.Column="1"
                                    Margin="8,0,0,0"
                                    Spacing="4">
                                    <Button
                                        Padding="0"
                                        Command="{Binding DecrementAgeCommand}"
                                        FontAttributes="Bold"
                                        HeightRequest="36"
                                        Style="{StaticResource OutlineButtonStyle}"
                                        Text="−"
                                        WidthRequest="36" />
                                    <Button
                                        Padding="0"
                                        Command="{Binding IncrementAgeCommand}"
                                        FontAttributes="Bold"
                                        HeightRequest="36"
                                        Style="{StaticResource OutlineButtonStyle}"
                                        Text="+"
                                        WidthRequest="36" />
                                </HorizontalStackLayout>
                            </Grid>
                        </VerticalStackLayout>
                    </VerticalStackLayout>
                </Border>

                <!--  Watering Schedule Card  -->
                <Border Padding="16" Style="{StaticResource ElevatedCardStyle}">
                    <VerticalStackLayout Spacing="16">
                        <HorizontalStackLayout Spacing="12">
                            <Border
                                Padding="8"
                                BackgroundColor="{AppThemeBinding Light={StaticResource Primary},
                                                                  Dark={StaticResource PrimaryDark}}"
                                StrokeThickness="0"
                                VerticalOptions="Center">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="8" />
                                </Border.StrokeShape>
                                <Label
                                    FontFamily="MaterialIconsRegular"
                                    FontSize="20"
                                    Text="&#xe798;"
                                    TextColor="White"
                                    VerticalOptions="Center" />
                            </Border>
                            <Label
                                Style="{StaticResource TitleSmallStyle}"
                                Text="{Binding Path=[WateringSchedule], Source={x:Static utils:LocalizationManager.Instance}}"
                                VerticalOptions="Center" />
                        </HorizontalStackLayout>

                        <!--  Watering Interval  -->
                        <VerticalStackLayout Spacing="12">
                            <Label Style="{StaticResource LabelStyle}" Text="{Binding Path=[WateringInterval], Source={x:Static utils:LocalizationManager.Instance}}" />

                            <Grid RowDefinitions="Auto,Auto" ColumnDefinitions="*,Auto,Auto" RowSpacing="12" ColumnSpacing="8">
                                <!--  Days Row  -->
                                <Border
                                    Grid.Row="0"
                                    Grid.Column="0"
                                    Padding="12,0"
                                    Style="{StaticResource InputBorderStyle}">
                                    <Entry
                                        HorizontalTextAlignment="Center"
                                        Keyboard="Numeric"
                                        Placeholder="Days"
                                        Text="{Binding WateringFrequencyDays, Mode=TwoWay, Converter={StaticResource StringToIntConverter}}"
                                        VerticalOptions="Center" />
                                </Border>
                                <Label
                                    Grid.Row="0"
                                    Grid.Column="1"
                                    Style="{StaticResource BodyStyle}"
                                    Text="{Binding Path=[Days], Source={x:Static utils:LocalizationManager.Instance}}"
                                    VerticalOptions="Center" />
                                <HorizontalStackLayout
                                    Grid.Row="0"
                                    Grid.Column="2"
                                    Spacing="4">
                                    <Button
                                        Padding="0"
                                        Command="{Binding DecrementWateringDaysCommand}"
                                        FontAttributes="Bold"
                                        HeightRequest="36"
                                        Style="{StaticResource OutlineButtonStyle}"
                                        Text="−"
                                        WidthRequest="36" />
                                    <Button
                                        Padding="0"
                                        Command="{Binding IncrementWateringDaysCommand}"
                                        FontAttributes="Bold"
                                        HeightRequest="36"
                                        Style="{StaticResource OutlineButtonStyle}"
                                        Text="+"
                                        WidthRequest="36" />
                                </HorizontalStackLayout>

                                <!--  Hours Row  -->
                                <Border
                                    Grid.Row="1"
                                    Grid.Column="0"
                                    Padding="12,0"
                                    Style="{StaticResource InputBorderStyle}">
                                    <Entry
                                        HorizontalTextAlignment="Center"
                                        Keyboard="Numeric"
                                        Placeholder="Hours"
                                        Text="{Binding WateringFrequencyHours, Mode=TwoWay, Converter={StaticResource StringToIntConverter}}"
                                        VerticalOptions="Center" />
                                </Border>
                                <Label
                                    Grid.Row="1"
                                    Grid.Column="1"
                                    Style="{StaticResource BodyStyle}"
                                    Text="{Binding Path=[Hours], Source={x:Static utils:LocalizationManager.Instance}}"
                                    VerticalOptions="Center" />
                                <HorizontalStackLayout
                                    Grid.Row="1"
                                    Grid.Column="2"
                                    Spacing="4">
                                    <Button
                                        Padding="0"
                                        Command="{Binding DecrementWateringHoursCommand}"
                                        FontAttributes="Bold"
                                        HeightRequest="36"
                                        Style="{StaticResource OutlineButtonStyle}"
                                        Text="−"
                                        WidthRequest="36" />
                                    <Button
                                        Padding="0"
                                        Command="{Binding IncrementWateringHoursCommand}"
                                        FontAttributes="Bold"
                                        HeightRequest="36"
                                        Style="{StaticResource OutlineButtonStyle}"
                                        Text="+"
                                        WidthRequest="36" />
                                </HorizontalStackLayout>
                            </Grid>
                        </VerticalStackLayout>

                        <!--  Last Watering  -->
                        <VerticalStackLayout Spacing="8">
                            <Label Style="{StaticResource LabelStyle}" Text="{Binding Path=[ModifyLastWatering], Source={x:Static utils:LocalizationManager.Instance}}" />

                            <Grid RowDefinitions="Auto,Auto" ColumnDefinitions="*,*" RowSpacing="8" ColumnSpacing="8">
                                <!-- Row 0: Date and Time Pickers -->
                                <Border Grid.Row="0" Grid.Column="0" Padding="8,0" Style="{StaticResource InputBorderStyle}">
                                    <DatePicker
                                        BackgroundColor="Transparent"
                                        Date="{Binding LastWateredDate, Mode=TwoWay}"
                                        HorizontalOptions="Fill" />
                                </Border>
                                <Border Grid.Row="0" Grid.Column="1" Padding="8,0" Style="{StaticResource InputBorderStyle}">
                                    <TimePicker
                                        BackgroundColor="Transparent"
                                        HorizontalOptions="Fill"
                                        Time="{Binding LastWateredTime, Mode=TwoWay}" />
                                </Border>

                                <!-- Row 1: Button spanning full width -->
                                <Button
                                    Grid.Row="1"
                                    Grid.Column="0"
                                    Grid.ColumnSpan="2"
                                    Command="{Binding SetCurrentTimeAsLastWateredCommand}"
                                    HeightRequest="40"
                                    HorizontalOptions="Fill"
                                    Style="{StaticResource OutlineButtonStyle}"
                                    Text="{Binding Path=[SetAsNow], Source={x:Static utils:LocalizationManager.Instance}}" />
                            </Grid>
                        </VerticalStackLayout>
                    </VerticalStackLayout>
                </Border>

                <!--  Fertilization Schedule Card  -->
                <Border Padding="16" Style="{StaticResource ElevatedCardStyle}">
                    <VerticalStackLayout Spacing="16">
                        <HorizontalStackLayout Spacing="12">
                            <Border
                                Padding="8"
                                BackgroundColor="{AppThemeBinding Light={StaticResource Primary},
                                                                  Dark={StaticResource PrimaryDark}}"
                                StrokeThickness="0"
                                VerticalOptions="Center">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="8" />
                                </Border.StrokeShape>
                                <Label
                                    FontFamily="MaterialIconsRegular"
                                    FontSize="20"
                                    Text="&#xe761;"
                                    TextColor="White"
                                    VerticalOptions="Center" />
                            </Border>
                            <Label
                                Style="{StaticResource TitleSmallStyle}"
                                Text="{Binding Path=[FertilizationSchedule], Source={x:Static utils:LocalizationManager.Instance}}"
                                VerticalOptions="Center" />
                        </HorizontalStackLayout>

                        <!--  Fertilization Interval  -->
                        <VerticalStackLayout Spacing="12">
                            <Label Style="{StaticResource LabelStyle}" Text="{Binding Path=[FertilizationInterval], Source={x:Static utils:LocalizationManager.Instance}}" />

                            <Grid RowDefinitions="Auto,Auto" ColumnDefinitions="*,Auto,Auto" RowSpacing="12" ColumnSpacing="8">
                                <!--  Days Row  -->
                                <Border
                                    Grid.Row="0"
                                    Grid.Column="0"
                                    Padding="12,0"
                                    Style="{StaticResource InputBorderStyle}">
                                    <Entry
                                        HorizontalTextAlignment="Center"
                                        Keyboard="Numeric"
                                        Placeholder="Days"
                                        Text="{Binding FertilizationFrequencyDays, Mode=TwoWay, Converter={StaticResource StringToIntConverter}}"
                                        VerticalOptions="Center" />
                                </Border>
                                <Label
                                    Grid.Row="0"
                                    Grid.Column="1"
                                    Style="{StaticResource BodyStyle}"
                                    Text="{Binding Path=[Days], Source={x:Static utils:LocalizationManager.Instance}}"
                                    VerticalOptions="Center" />
                                <HorizontalStackLayout
                                    Grid.Row="0"
                                    Grid.Column="2"
                                    Spacing="4">
                                    <Button
                                        Padding="0"
                                        Command="{Binding DecrementFertilizationDaysCommand}"
                                        FontAttributes="Bold"
                                        HeightRequest="36"
                                        Style="{StaticResource OutlineButtonStyle}"
                                        Text="−"
                                        WidthRequest="36" />
                                    <Button
                                        Padding="0"
                                        Command="{Binding IncrementFertilizationDaysCommand}"
                                        FontAttributes="Bold"
                                        HeightRequest="36"
                                        Style="{StaticResource OutlineButtonStyle}"
                                        Text="+"
                                        WidthRequest="36" />
                                </HorizontalStackLayout>

                                <!--  Hours Row  -->
                                <Border
                                    Grid.Row="1"
                                    Grid.Column="0"
                                    Padding="12,0"
                                    Style="{StaticResource InputBorderStyle}">
                                    <Entry
                                        HorizontalTextAlignment="Center"
                                        Keyboard="Numeric"
                                        Placeholder="Hours"
                                        Text="{Binding FertilizationFrequencyHours, Mode=TwoWay, Converter={StaticResource StringToIntConverter}}"
                                        VerticalOptions="Center" />
                                </Border>
                                <Label
                                    Grid.Row="1"
                                    Grid.Column="1"
                                    Style="{StaticResource BodyStyle}"
                                    Text="{Binding Path=[Hours], Source={x:Static utils:LocalizationManager.Instance}}"
                                    VerticalOptions="Center" />
                                <HorizontalStackLayout
                                    Grid.Row="1"
                                    Grid.Column="2"
                                    Spacing="4">
                                    <Button
                                        Padding="0"
                                        Command="{Binding DecrementFertilizationHoursCommand}"
                                        FontAttributes="Bold"
                                        HeightRequest="36"
                                        Style="{StaticResource OutlineButtonStyle}"
                                        Text="−"
                                        WidthRequest="36" />
                                    <Button
                                        Padding="0"
                                        Command="{Binding IncrementFertilizationHoursCommand}"
                                        FontAttributes="Bold"
                                        HeightRequest="36"
                                        Style="{StaticResource OutlineButtonStyle}"
                                        Text="+"
                                        WidthRequest="36" />
                                </HorizontalStackLayout>
                            </Grid>
                        </VerticalStackLayout>

                        <!--  Last Fertilization  -->
                        <VerticalStackLayout Spacing="8">
                            <Label Style="{StaticResource LabelStyle}" Text="{Binding Path=[ModifyLastFertilization], Source={x:Static utils:LocalizationManager.Instance}}" />

                            <Grid RowDefinitions="Auto,Auto" ColumnDefinitions="*,*" RowSpacing="8" ColumnSpacing="8">
                                <!-- Row 0: Date and Time Pickers -->
                                <Border Grid.Row="0" Grid.Column="0" Padding="8,0" Style="{StaticResource InputBorderStyle}">
                                    <DatePicker
                                        BackgroundColor="Transparent"
                                        Date="{Binding LastFertilizationDate, Mode=TwoWay}"
                                        HorizontalOptions="Fill" />
                                </Border>
                                <Border Grid.Row="0" Grid.Column="1" Padding="8,0" Style="{StaticResource InputBorderStyle}">
                                    <TimePicker
                                        BackgroundColor="Transparent"
                                        HorizontalOptions="Fill"
                                        Time="{Binding LastFertilizationTime, Mode=TwoWay}" />
                                </Border>

                                <!-- Row 1: Button spanning full width -->
                                <Button
                                    Grid.Row="1"
                                    Grid.Column="0"
                                    Grid.ColumnSpan="2"
                                    Command="{Binding SetCurrentTimeAsLastFertilizationCommand}"
                                    HeightRequest="40"
                                    HorizontalOptions="Fill"
                                    Style="{StaticResource OutlineButtonStyle}"
                                    Text="{Binding Path=[SetAsNow], Source={x:Static utils:LocalizationManager.Instance}}" />
                            </Grid>
                        </VerticalStackLayout>
                    </VerticalStackLayout>
                </Border>

                <!--  Notes Card  -->
                <Border Padding="16" Style="{StaticResource ModernCardStyle}">
                    <VerticalStackLayout Spacing="12">
                        <HorizontalStackLayout Spacing="12">
                            <Border
                                Padding="8"
                                BackgroundColor="{AppThemeBinding Light={StaticResource Primary},
                                                                  Dark={StaticResource PrimaryDark}}"
                                StrokeThickness="0"
                                VerticalOptions="Center">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="8" />
                                </Border.StrokeShape>
                                <Label
                                    FontFamily="MaterialIconsRegular"
                                    FontSize="20"
                                    Text="&#xe24d;"
                                    TextColor="White"
                                    VerticalOptions="Center" />
                            </Border>
                            <Label
                                Style="{StaticResource TitleSmallStyle}"
                                Text="{Binding Path=[Notes], Source={x:Static utils:LocalizationManager.Instance}}"
                                VerticalOptions="Center" />
                        </HorizontalStackLayout>

                        <Border
                            Padding="12"
                            HeightRequest="120"
                            Style="{StaticResource InputBorderStyle}">
                            <Editor
                                AutoSize="TextChanges"
                                BackgroundColor="Transparent"
                                Placeholder="Add notes about your plant..."
                                Text="{Binding Notes}" />
                        </Border>
                    </VerticalStackLayout>
                </Border>

                <!--  Validation Errors  -->
                <VerticalStackLayout Padding="0" BindableLayout.ItemsSource="{Binding Errors}">
                    <BindableLayout.ItemTemplate>
                        <DataTemplate x:DataType="dataAnnotations:ValidationResult">
                            <Border
                                Margin="0,4"
                                Padding="16"
                                BackgroundColor="{AppThemeBinding Light={StaticResource DangerColor},
                                                                  Dark={StaticResource DangerColor}}"
                                Opacity="0.1"
                                Style="{StaticResource ModernCardStyle}">
                                <HorizontalStackLayout Spacing="12">
                                    <Label
                                        FontFamily="MaterialIconsRegular"
                                        FontSize="24"
                                        Text="&#xe002;"
                                        TextColor="{StaticResource DangerColor}"
                                        VerticalOptions="Center" />
                                    <Label
                                        Style="{StaticResource BodyStyle}"
                                        Text="{Binding ErrorMessage}"
                                        TextColor="{StaticResource DangerColor}"
                                        VerticalOptions="Center" />
                                </HorizontalStackLayout>
                            </Border>
                        </DataTemplate>
                    </BindableLayout.ItemTemplate>
                </VerticalStackLayout>

                <!--  Save Button  -->
                <Button
                    Margin="0,0,0,16"
                    Command="{Binding SubmitCommand}"
                    FontAttributes="Bold"
                    HeightRequest="52"
                    HorizontalOptions="Fill"
                    IsEnabled="{Binding IsBusy, Converter={StaticResource InvertedBoolConverter}}"
                    Text="{Binding Path=[Save], Source={x:Static utils:LocalizationManager.Instance}}" />
            </VerticalStackLayout>
        </ScrollView>

        <components:LoadingOverlayView IsVisible="{Binding IsLoading}" />
    </Grid>
</ContentPage>
