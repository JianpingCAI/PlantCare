<?xml version="1.0" encoding="utf-8" ?>

<views:ContentPageBase
    x:Class="PlantCare.App.Views.SettingsView"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:am="clr-namespace:Microsoft.Maui.ApplicationModel;assembly=Microsoft.Maui.Essentials"
    xmlns:components="clr-namespace:PlantCare.App.Components"
    xmlns:local="clr-namespace:PlantCare.App.Resources.Styles"
    xmlns:strings="clr-namespace:PlantCare.App.Resources"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    xmlns:utils="clr-namespace:PlantCare.App.Utils"
    xmlns:views="clr-namespace:PlantCare.App.Views"
    xmlns:vm="clr-namespace:PlantCare.App.ViewModels"
    x:DataType="vm:SettingsViewModel">

    <!--  Title area: shows page icon and localized title text bound via LocalizationManager  -->
    <Shell.TitleView>
        <Grid
            Padding="12,0,8,0"
            ColumnDefinitions="auto,*"
            ColumnSpacing="12">
            <!--  Icon  -->
            <Border
                HorizontalOptions="Start"
                Stroke="Transparent"
                StrokeThickness="0"
                VerticalOptions="Center">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="12" />
                </Border.StrokeShape>
                <Border.Shadow>
                    <Shadow
                        Brush="{StaticResource Primary}"
                        Opacity="0.15"
                        Radius="8"
                        Offset="0,2" />
                </Border.Shadow>
                <Image
                    HeightRequest="44"
                    Source="default_plant.png"
                    WidthRequest="44" />
            </Border>

            <!--  Title  -->
            <Label
                Grid.Column="1"
                Style="{StaticResource TitleSmallStyle}"
                Text="{Binding Path=[Settings], Source={x:Static utils:LocalizationManager.Instance}}"
                VerticalOptions="Center"
                VerticalTextAlignment="Center" />
        </Grid>
    </Shell.TitleView>

    <!--  Resources: control template for theme radio buttons and converters  -->
    <ContentPage.Resources>
        <!--
            Template used by RadioButton theme selectors.
            Visual states control the checked/unchecked appearance (stroke + inner ellipse opacity).
        -->
        <ControlTemplate x:Key="ThemeRadioTemplate">
            <Border
                Padding="2"
                BackgroundColor="{AppThemeBinding Light={StaticResource Gray100},
                                                  Dark={StaticResource Gray900}}"
                HeightRequest="120"
                HorizontalOptions="Start"
                Stroke="Transparent"
                VerticalOptions="Start"
                WidthRequest="100">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="10" />
                </Border.StrokeShape>
                <Grid Margin="8">
                    <!--  Check indicator: outer and inner ellipse  -->
                    <Grid
                        HeightRequest="18"
                        HorizontalOptions="End"
                        VerticalOptions="Start"
                        WidthRequest="18">
                        <Ellipse
                            Fill="White"
                            HeightRequest="16"
                            HorizontalOptions="Center"
                            Stroke="{StaticResource DarkGray}"
                            StrokeThickness="0.5"
                            VerticalOptions="Center"
                            WidthRequest="16" />
                        <Ellipse
                            x:Name="uiEllipseCheck"
                            Fill="{StaticResource Primary}"
                            HeightRequest="8"
                            HorizontalOptions="Center"
                            Stroke="{StaticResource Primary}"
                            VerticalOptions="Center"
                            WidthRequest="8" />
                    </Grid>
                    <!--  ContentPresenter hosts the RadioButton content (icon + label)  -->
                    <ContentPresenter />
                </Grid>

                <!--  Visual states to toggle stroke color and inner ellipse visibility  -->
                <VisualStateManager.VisualStateGroups>
                    <VisualStateGroupList>
                        <VisualStateGroup x:Name="CheckedStates">
                            <VisualState x:Name="Checked">
                                <VisualState.Setters>
                                    <Setter Property="Stroke" Value="{StaticResource Primary}" />
                                    <Setter TargetName="uiEllipseCheck" Property="Opacity" Value="1" />
                                </VisualState.Setters>
                            </VisualState>

                            <VisualState x:Name="Unchecked">
                                <VisualState.Setters>
                                    <Setter Property="Stroke" Value="{StaticResource Secondary}" />
                                    <Setter TargetName="uiEllipseCheck" Property="Opacity" Value="0" />
                                </VisualState.Setters>
                            </VisualState>
                        </VisualStateGroup>
                    </VisualStateGroupList>
                </VisualStateManager.VisualStateGroups>
            </Border>
        </ControlTemplate>

        <!--  Converters and other shared resources  -->
        <ResourceDictionary>
            <utils:EnumDescriptionConverter x:Key="EnumDescConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <!--  Main content grid with padding; includes a ScrollView for all settings sections  -->
    <Grid Padding="12,8,12,0">
        <ScrollView>
            <VerticalStackLayout Spacing="0">

                <!--  Notifications Section header  -->
                <!--
                <Label Style="{StaticResource SettingsSectionHeaderStyle}" Text="{Binding Path=[NotificationSettings], Source={x:Static utils:LocalizationManager.Instance}, FallbackValue='NOTIFICATIONS'}" />-->

                <!--  Notifications card: contains toggles for watering and fertilization notifications  -->
                <Border Style="{StaticResource SettingsCardStyle}">
                    <VerticalStackLayout Spacing="12">
                        <!--
                            IsWateringNotificationEnabled row:
                            - Label for the setting name (localized)
                            - Switch bound to IsWateringNotificationEnabled
                            - EventToCommandBehavior triggers ToggleWateringNotificationCommand with the switch state
                        -->
                        <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto">
                            <Label Style="{StaticResource SettingsItemLabelStyle}" Text="{Binding Path=[WateringNotification], Source={x:Static utils:LocalizationManager.Instance}}" />
                            <Switch
                                x:Name="wateringSwitch"
                                Grid.Column="1"
                                HorizontalOptions="End"
                                IsToggled="{Binding IsWateringNotificationEnabled}"
                                VerticalOptions="Center">
                                <Switch.Behaviors>
                                    <toolkit:EventToCommandBehavior
                                        Command="{Binding ToggleWateringNotificationCommand}"
                                        CommandParameter="{Binding Source={x:Reference wateringSwitch}, Path=IsToggled}"
                                        EventName="Toggled" />
                                </Switch.Behaviors>
                            </Switch>
                        </Grid>

                        <!--  Divider between notification items  -->
                        <BoxView HeightRequest="1" Color="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray800}}" />

                        <!--
                            IsFertilizationNotificationEnabled row:
                            - Label and Switch with behavior similar to wateringSwitch
                        -->
                        <Grid ColumnDefinitions="*,Auto">
                            <Label Style="{StaticResource SettingsItemLabelStyle}" Text="{Binding Path=[FertilizationNotification], Source={x:Static utils:LocalizationManager.Instance}}" />
                            <Switch
                                x:Name="fertilizationSwitch"
                                Grid.Column="1"
                                HorizontalOptions="End"
                                IsToggled="{Binding IsFertilizationNotificationEnabled}"
                                VerticalOptions="Center">
                                <Switch.Behaviors>
                                    <toolkit:EventToCommandBehavior
                                        Command="{Binding ToggleFertilizationNotificationCommand}"
                                        CommandParameter="{Binding Source={x:Reference fertilizationSwitch}, Path=IsToggled}"
                                        EventName="Toggled" />
                                </Switch.Behaviors>
                            </Switch>
                        </Grid>
                    </VerticalStackLayout>
                </Border>

                <!--  Appearance Section header  -->

                <!--
                    Language selection card:
                    - Picker bound to LanguageProvider.All as ItemsSource
                    - SelectedLanguage bound to view model
                    - Uses EnumDescriptionConverter to show friendly names
                -->
                <Border Style="{StaticResource SettingsCardStyle}">
                    <Grid ColumnDefinitions="*,*" RowDefinitions="Auto">
                        <Label Style="{StaticResource SettingsItemLabelStyle}" Text="{Binding Path=[Language], Source={x:Static utils:LocalizationManager.Instance}}" />
                        <Picker
                            x:Name="langPicker"
                            Grid.Column="1"
                            HorizontalOptions="End"
                            ItemDisplayBinding="{Binding Converter={StaticResource EnumDescConverter}}"
                            ItemsSource="{Binding Source={x:Static utils:LanguageProvider.All}}"
                            SelectedItem="{Binding SelectedLanguage}" />
                    </Grid>
                </Border>

                <!--
                    Theme selection card:
                    - RadioButton group to choose AppTheme (Unspecified, Dark, Light)
                    - Uses ThemeRadioTemplate for consistent tile UI
                    - RadioButton.CheckedChanged handled in code-behind via RadioButton_CheckedChanged
                -->
                <Border Style="{StaticResource SettingsCardStyle}">
                    <VerticalStackLayout Spacing="12">
                        <Label Style="{StaticResource SettingsItemLabelStyle}" Text="{Binding Path=[Theme], Source={x:Static utils:LocalizationManager.Instance}}" />

                        <Grid
                            ColumnDefinitions="*,*,*"
                            HorizontalOptions="Fill"
                            RadioButtonGroup.GroupName="AppTheme"
                            RadioButtonGroup.SelectedValue="{Binding SelectedTheme}">

                            <Grid.Resources>
                                <Style TargetType="RadioButton">
                                    <Setter Property="ControlTemplate" Value="{StaticResource ThemeRadioTemplate}" />
                                </Style>
                            </Grid.Resources>

                            <!--  Default / Unspecified theme option  -->
                            <RadioButton
                                CheckedChanged="RadioButton_CheckedChanged"
                                HorizontalOptions="Center"
                                IsChecked="True"
                                Value="{x:Static am:AppTheme.Unspecified}">
                                <RadioButton.Content>
                                    <Grid RowDefinitions="4*,1*">
                                        <Image HorizontalOptions="Center" VerticalOptions="Center">
                                            <Image.Source>
                                                <FontImageSource
                                                    FontFamily="FontAwesome"
                                                    Glyph="{x:Static local:IconFont.Mobile}"
                                                    Size="32" />
                                            </Image.Source>
                                        </Image>
                                        <Label
                                            Grid.Row="1"
                                            FontSize="12"
                                            HorizontalOptions="Center"
                                            Text="{Binding Path=[Default], Source={x:Static utils:LocalizationManager.Instance}}"
                                            VerticalOptions="Center" />
                                    </Grid>
                                </RadioButton.Content>
                            </RadioButton>

                            <!--  Dark theme option  -->
                            <RadioButton
                                Grid.Column="1"
                                CheckedChanged="RadioButton_CheckedChanged"
                                HorizontalOptions="Center"
                                Value="{x:Static am:AppTheme.Dark}">
                                <RadioButton.Content>
                                    <Grid RowDefinitions="4*,1*">
                                        <Image HorizontalOptions="Center" VerticalOptions="Center">
                                            <Image.Source>
                                                <FontImageSource
                                                    FontFamily="FontAwesome"
                                                    Glyph="{x:Static local:IconFont.Lightbulb}"
                                                    Size="32"
                                                    Color="Black" />
                                            </Image.Source>
                                        </Image>
                                        <Label
                                            Grid.Row="1"
                                            FontSize="12"
                                            HorizontalOptions="Center"
                                            Text="{Binding Path=[Dark], Source={x:Static utils:LocalizationManager.Instance}}"
                                            VerticalOptions="Center" />
                                    </Grid>
                                </RadioButton.Content>
                            </RadioButton>

                            <!--  Light theme option  -->
                            <RadioButton
                                Grid.Column="2"
                                CheckedChanged="RadioButton_CheckedChanged"
                                HorizontalOptions="Center"
                                Value="{x:Static am:AppTheme.Light}">
                                <RadioButton.Content>
                                    <Grid RowDefinitions="4*,1*">
                                        <!--  Replaced obsolete FontImage extension with FontImageSource  -->
                                        <Image HorizontalOptions="Center" VerticalOptions="Center">
                                            <Image.Source>
                                                <FontImageSource
                                                    FontFamily="FontAwesome"
                                                    Glyph="{x:Static local:IconFont.Lightbulb}"
                                                    Size="32"
                                                    Color="White" />
                                            </Image.Source>
                                        </Image>
                                        <Label
                                            Grid.Row="1"
                                            FontSize="12"
                                            HorizontalOptions="Center"
                                            Text="{Binding Path=[Light], Source={x:Static utils:LocalizationManager.Instance}}"
                                            VerticalOptions="Center" />
                                    </Grid>
                                </RadioButton.Content>
                            </RadioButton>
                        </Grid>
                    </VerticalStackLayout>
                </Border>

                <!--
                    Export and Import card:
                    - Export button triggers ExportDataCommand
                    - Import button triggers ImportDataCommand
                    - Checkbox toggles IsRemoveExistingData which influences import behavior
                -->
                <Border Style="{StaticResource SettingsCardStyle}">
                    <VerticalStackLayout Spacing="12">
                        <!--  Export row: description and action button  -->
                        <Grid ColumnDefinitions="*,Auto">
                            <VerticalStackLayout VerticalOptions="Center">
                                <Label Style="{StaticResource SettingsItemLabelStyle}" Text="{Binding Path=[Export], Source={x:Static utils:LocalizationManager.Instance}}" />
                                <!--<Label Style="{StaticResource SettingsItemDescriptionStyle}" Text="Export all plant data to a file" />-->
                            </VerticalStackLayout>
                            <Button
                                Grid.Column="1"
                                Padding="16,8"
                                Command="{Binding ExportDataCommand}"
                                FontSize="13"
                                HorizontalOptions="End"
                                Style="{StaticResource OutlineButtonStyle}"
                                Text="{Binding Path=[Export], Source={x:Static utils:LocalizationManager.Instance}}"
                                VerticalOptions="Center" />
                        </Grid>

                        <!--  Divider between export and import  -->
                        <BoxView HeightRequest="1" Color="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray800}}" />

                        <!--  Import row: description and action button  -->
                        <Grid ColumnDefinitions="*,Auto">
                            <VerticalStackLayout VerticalOptions="Center">
                                <Label Style="{StaticResource SettingsItemLabelStyle}" Text="{Binding Path=[Import], Source={x:Static utils:LocalizationManager.Instance}}" />
                                <!--<Label Style="{StaticResource SettingsItemDescriptionStyle}" Text="Import plant data from a file" />-->
                            </VerticalStackLayout>
                            <Button
                                Grid.Column="1"
                                Padding="16,8"
                                Command="{Binding ImportDataCommand}"
                                FontSize="13"
                                HorizontalOptions="End"
                                Style="{StaticResource OutlineButtonStyle}"
                                Text="{Binding Path=[Import], Source={x:Static utils:LocalizationManager.Instance}}"
                                VerticalOptions="Center" />
                        </Grid>

                        <!--  Option to remove existing data when importing  -->
                        <Grid ColumnDefinitions="Auto,*">
                            <CheckBox
                                HorizontalOptions="Start"
                                IsChecked="{Binding IsRemoveExistingData}"
                                VerticalOptions="Center" />
                            <Label
                                Grid.Column="1"
                                Style="{StaticResource SettingsItemDescriptionStyle}"
                                Text="{Binding Path=[RemoveExistingData], Source={x:Static utils:LocalizationManager.Instance}}"
                                VerticalOptions="Center" />
                        </Grid>
                    </VerticalStackLayout>
                </Border>

                <!--
                    Log viewer card:
                    - Button triggers CheckLogsCommand to show application logs for troubleshooting
                -->
                <Border Style="{StaticResource SettingsCardStyle}">
                    <Grid ColumnDefinitions="*,Auto">
                        <VerticalStackLayout VerticalOptions="Center">
                            <Label Style="{StaticResource SettingsItemLabelStyle}" Text="{Binding Path=[LogsSetting], Source={x:Static utils:LocalizationManager.Instance}}" />
                        </VerticalStackLayout>
                        <Button
                            Grid.Column="1"
                            Padding="16,8"
                            Command="{Binding CheckLogsCommand}"
                            FontSize="13"
                            HorizontalOptions="End"
                            Style="{StaticResource OutlineButtonStyle}"
                            Text="{Binding Path=[ShowLogs], Source={x:Static utils:LocalizationManager.Instance}, FallbackValue='View'}"
                            VerticalOptions="Center" />
                    </Grid>
                </Border>

                <!--
                    About card:
                    - Displays app information (version, description, developer)
                -->
                <Border Style="{StaticResource SettingsCardStyle}">
                    <VerticalStackLayout Spacing="8">
                        <Label
                            FontAttributes="Bold"
                            FontSize="16"
                            Style="{StaticResource SettingsItemLabelStyle}"
                            Text="{Binding Path=[About], Source={x:Static utils:LocalizationManager.Instance}}" />

                        <Grid ColumnDefinitions="Auto,*" RowDefinitions="Auto,Auto">
                            <Label
                                FontAttributes="Bold"
                                FontSize="13"
                                Style="{StaticResource SettingsItemLabelStyle}"
                                Text="{Binding Path=[Version], Source={x:Static utils:LocalizationManager.Instance}}" />
                            <Label
                                Grid.Column="1"
                                Margin="8,0,0,0"
                                FontSize="13"
                                Style="{StaticResource BodySmallStyle}"
                                Text="{Binding AppVersion}"
                                VerticalTextAlignment="Center" />

                            <Label
                                Grid.Row="1"
                                Margin="0,8,0,0"
                                FontAttributes="Bold"
                                FontSize="13"
                                Style="{StaticResource SettingsItemLabelStyle}"
                                Text="{Binding Path=[Developer], Source={x:Static utils:LocalizationManager.Instance}}" />
                            <Label
                                Grid.Row="1"
                                Grid.Column="1"
                                Margin="8,8,0,0"
                                FontSize="13"
                                Style="{StaticResource BodySmallStyle}"
                                Text="Jianping (cai-jianping@outlook.com)"
                                VerticalTextAlignment="Center" />
                        </Grid>

                        <BoxView HeightRequest="1" Color="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray800}}" />

                        <Label
                            FontSize="12"
                            Style="{StaticResource BodySmallStyle}"
                            Text="{Binding Path=[AppDescription], Source={x:Static utils:LocalizationManager.Instance}}" />
                    </VerticalStackLayout>
                </Border>
            </VerticalStackLayout>
        </ScrollView>

        <!--  Loading overlay component shown when IsLoading is true in the view model  -->
        <components:LoadingOverlayView IsVisible="{Binding IsLoading}" />
    </Grid>
</views:ContentPageBase>

