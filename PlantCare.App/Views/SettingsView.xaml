<?xml version="1.0" encoding="utf-8" ?>

<views:ContentPageBase
    x:Class="PlantCare.App.Views.SettingsView"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:am="clr-namespace:Microsoft.Maui.ApplicationModel;assembly=Microsoft.Maui.Essentials"
    xmlns:components="clr-namespace:PlantCare.App.Components"
    xmlns:local="clr-namespace:PlantCare.App.Resources.Styles"
    xmlns:strings="clr-namespace:PlantCare.App.Resources"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    xmlns:utils="clr-namespace:PlantCare.App.Utils"
    xmlns:views="clr-namespace:PlantCare.App.Views"
    xmlns:vm="clr-namespace:PlantCare.App.ViewModels"
    x:DataType="vm:SettingsViewModel">

    <Shell.TitleView>
        <Grid ColumnDefinitions="auto,*">
            <Border
                Margin="5,0,0,0"
                HorizontalOptions="Start"
                Stroke="Transparent"
                StrokeThickness="0"
                VerticalOptions="Center">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="40" />
                </Border.StrokeShape>
                <Image HeightRequest="40" Source="default_plant.png" />
            </Border>

            <Label
                Grid.Column="1"
                Margin="15,0,0,0"
                HorizontalOptions="Start"
                Style="{StaticResource BodyStyle}"
                Text="{Binding Path=[Settings], Source={x:Static utils:LocalizationManager.Instance}}"
                VerticalTextAlignment="Center" />
        </Grid>
    </Shell.TitleView>
    <ContentPage.Resources>
        <ControlTemplate x:Key="ThemeRadioTemplate">
            <Border
                Padding="2"
                BackgroundColor="{AppThemeBinding Light={StaticResource Gray100},
                                                  Dark={StaticResource Gray900}}"
                HeightRequest="120"
                HorizontalOptions="Start"
                Stroke="Transparent"
                VerticalOptions="Start"
                WidthRequest="100">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="10" />
                </Border.StrokeShape>
                <Grid Margin="8">
                    <Grid
                        HeightRequest="18"
                        HorizontalOptions="End"
                        VerticalOptions="Start"
                        WidthRequest="18">
                        <Ellipse
                            Fill="White"
                            HeightRequest="16"
                            HorizontalOptions="Center"
                            Stroke="{StaticResource DarkGray}"
                            StrokeThickness="0.5"
                            VerticalOptions="Center"
                            WidthRequest="16" />
                        <Ellipse
                            x:Name="uiEllipseCheck"
                            Fill="{StaticResource Primary}"
                            HeightRequest="8"
                            HorizontalOptions="Center"
                            Stroke="{StaticResource Primary}"
                            VerticalOptions="Center"
                            WidthRequest="8" />
                    </Grid>
                    <ContentPresenter />
                </Grid>

                <VisualStateManager.VisualStateGroups>
                    <VisualStateGroupList>
                        <VisualStateGroup x:Name="CheckedStates">
                            <VisualState x:Name="Checked">
                                <VisualState.Setters>
                                    <Setter Property="Stroke" Value="{StaticResource Primary}" />
                                    <Setter TargetName="uiEllipseCheck" Property="Opacity" Value="1" />
                                </VisualState.Setters>
                            </VisualState>

                            <VisualState x:Name="Unchecked">
                                <VisualState.Setters>
                                    <Setter Property="Stroke" Value="{StaticResource Secondary}" />
                                    <Setter TargetName="uiEllipseCheck" Property="Opacity" Value="0" />
                                </VisualState.Setters>
                            </VisualState>
                        </VisualStateGroup>
                    </VisualStateGroupList>
                </VisualStateManager.VisualStateGroups>
            </Border>
        </ControlTemplate>
        <ResourceDictionary>
            <utils:EnumDescriptionConverter x:Key="EnumDescConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>
    <Grid Padding="12,8,12,0">
        <ScrollView>
            <VerticalStackLayout Spacing="0">

                <!--  Notifications Section  -->
                <Label Style="{StaticResource SettingsSectionHeaderStyle}" Text="{Binding Path=[Notifications], Source={x:Static utils:LocalizationManager.Instance}, FallbackValue='NOTIFICATIONS'}" />

                <Border Style="{StaticResource SettingsCardStyle}">
                    <VerticalStackLayout Spacing="12">
                        <!--  IsWateringNotificationEnabled  -->
                        <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto">
                            <Label Style="{StaticResource SettingsItemLabelStyle}" Text="{Binding Path=[WateringNotification], Source={x:Static utils:LocalizationManager.Instance}}" />
                            <Switch
                                x:Name="wateringSwitch"
                                Grid.Column="1"
                                HorizontalOptions="End"
                                IsToggled="{Binding IsWateringNotificationEnabled}"
                                VerticalOptions="Center">
                                <Switch.Behaviors>
                                    <toolkit:EventToCommandBehavior
                                        Command="{Binding ToggleWateringNotificationCommand}"
                                        CommandParameter="{Binding Source={x:Reference wateringSwitch}, Path=IsToggled}"
                                        EventName="Toggled" />
                                </Switch.Behaviors>
                            </Switch>
                        </Grid>

                        <!--  Divider  -->
                        <BoxView HeightRequest="1" Color="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray800}}" />

                        <!--  IsFertilizationNotificationEnabled  -->
                        <Grid ColumnDefinitions="*,Auto">
                            <Label Style="{StaticResource SettingsItemLabelStyle}" Text="{Binding Path=[FertilizationNotification], Source={x:Static utils:LocalizationManager.Instance}}" />
                            <Switch
                                x:Name="fertilizationSwitch"
                                Grid.Column="1"
                                HorizontalOptions="End"
                                IsToggled="{Binding IsFertilizationNotificationEnabled}"
                                VerticalOptions="Center">
                                <Switch.Behaviors>
                                    <toolkit:EventToCommandBehavior
                                        Command="{Binding ToggleFertilizationNotificationCommand}"
                                        CommandParameter="{Binding Source={x:Reference fertilizationSwitch}, Path=IsToggled}"
                                        EventName="Toggled" />
                                </Switch.Behaviors>
                            </Switch>
                        </Grid>
                    </VerticalStackLayout>
                </Border>

                <!--  Appearance Section  -->
                <Label Style="{StaticResource SettingsSectionHeaderStyle}" Text="{Binding Path=[Appearance], Source={x:Static utils:LocalizationManager.Instance}, FallbackValue='APPEARANCE'}" />

                <!--  Language  -->
                <Border Style="{StaticResource SettingsCardStyle}">
                    <Grid ColumnDefinitions="*,*" RowDefinitions="Auto">
                        <Label Style="{StaticResource SettingsItemLabelStyle}" Text="{Binding Path=[Language], Source={x:Static utils:LocalizationManager.Instance}}" />
                        <Picker
                            x:Name="langPicker"
                            Grid.Column="1"
                            HorizontalOptions="End"
                            ItemDisplayBinding="{Binding Converter={StaticResource EnumDescConverter}}"
                            ItemsSource="{Binding Source={x:Static utils:LanguageProvider.All}}"
                            SelectedItem="{Binding SelectedLanguage}" />
                    </Grid>
                </Border>

                <!--  Theme  -->
                <Border Style="{StaticResource SettingsCardStyle}">
                    <VerticalStackLayout Spacing="12">
                        <Label Style="{StaticResource SettingsItemLabelStyle}" Text="{Binding Path=[Theme], Source={x:Static utils:LocalizationManager.Instance}}" />

                        <Grid
                            ColumnDefinitions="*,*,*"
                            HorizontalOptions="Fill"
                            RadioButtonGroup.GroupName="AppTheme"
                            RadioButtonGroup.SelectedValue="{Binding SelectedTheme}">

                            <Grid.Resources>
                                <Style TargetType="RadioButton">
                                    <Setter Property="ControlTemplate" Value="{StaticResource ThemeRadioTemplate}" />
                                </Style>
                            </Grid.Resources>
                            <RadioButton
                                CheckedChanged="RadioButton_CheckedChanged"
                                HorizontalOptions="Center"
                                IsChecked="True"
                                Value="{x:Static am:AppTheme.Unspecified}">
                                <RadioButton.Content>
                                    <Grid RowDefinitions="4*,1*">
                                        <Image
                                            HorizontalOptions="Center"
                                            Source="{FontImage FontFamily=FontAwesome,
                                                               Glyph={x:Static local:IconFont.Mobile},
                                                               Size=32}"
                                            VerticalOptions="Center" />
                                        <Label
                                            Grid.Row="1"
                                            FontSize="12"
                                            HorizontalOptions="Center"
                                            Text="{Binding Path=[Default], Source={x:Static utils:LocalizationManager.Instance}}"
                                            VerticalOptions="Center" />
                                    </Grid>
                                </RadioButton.Content>
                            </RadioButton>
                            <RadioButton
                                Grid.Column="1"
                                CheckedChanged="RadioButton_CheckedChanged"
                                HorizontalOptions="Center"
                                Value="{x:Static am:AppTheme.Dark}">
                                <RadioButton.Content>
                                    <Grid RowDefinitions="4*,1*">
                                        <Image
                                            HorizontalOptions="Center"
                                            Source="{FontImage FontFamily=FontAwesome,
                                                               Glyph={x:Static local:IconFont.Lightbulb},
                                                               Color=Black,
                                                               Size=32}"
                                            VerticalOptions="Center" />
                                        <Label
                                            Grid.Row="1"
                                            FontSize="12"
                                            HorizontalOptions="Center"
                                            Text="{Binding Path=[Dark], Source={x:Static utils:LocalizationManager.Instance}}"
                                            VerticalOptions="Center" />
                                    </Grid>
                                </RadioButton.Content>
                            </RadioButton>
                            <RadioButton
                                Grid.Column="2"
                                CheckedChanged="RadioButton_CheckedChanged"
                                HorizontalOptions="Center"
                                Value="{x:Static am:AppTheme.Light}">
                                <RadioButton.Content>
                                    <Grid RowDefinitions="4*,1*">
                                        <Image
                                            HorizontalOptions="Center"
                                            Source="{FontImage FontFamily=FontAwesome,
                                                               Glyph={x:Static local:IconFont.Lightbulb},
                                                               Color=White,
                                                               Size=32}"
                                            VerticalOptions="Center" />
                                        <Label
                                            Grid.Row="1"
                                            FontSize="12"
                                            HorizontalOptions="Center"
                                            Text="{Binding Path=[Light], Source={x:Static utils:LocalizationManager.Instance}}"
                                            VerticalOptions="Center" />
                                    </Grid>
                                </RadioButton.Content>
                            </RadioButton>
                        </Grid>
                    </VerticalStackLayout>
                </Border>

                <!--  Data Section  -->
                <Label Style="{StaticResource SettingsSectionHeaderStyle}" Text="{Binding Path=[DataImportExport], Source={x:Static utils:LocalizationManager.Instance}}" />

                <!--  Export and Import  -->
                <Border Style="{StaticResource SettingsCardStyle}">
                    <VerticalStackLayout Spacing="12">
                        <Grid ColumnDefinitions="*,Auto">
                            <VerticalStackLayout VerticalOptions="Center">
                                <Label Style="{StaticResource SettingsItemLabelStyle}" Text="{Binding Path=[Export], Source={x:Static utils:LocalizationManager.Instance}}" />
                                <Label Style="{StaticResource SettingsItemDescriptionStyle}" Text="Export all plant data to a file" />
                            </VerticalStackLayout>
                            <Button
                                Grid.Column="1"
                                Padding="16,8"
                                Command="{Binding ExportDataCommand}"
                                FontSize="13"
                                HorizontalOptions="End"
                                Style="{StaticResource OutlineButtonStyle}"
                                Text="{Binding Path=[Export], Source={x:Static utils:LocalizationManager.Instance}}"
                                VerticalOptions="Center" />
                        </Grid>

                        <!--  Divider  -->
                        <BoxView HeightRequest="1" Color="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray800}}" />

                        <Grid ColumnDefinitions="*,Auto">
                            <VerticalStackLayout VerticalOptions="Center">
                                <Label Style="{StaticResource SettingsItemLabelStyle}" Text="{Binding Path=[Import], Source={x:Static utils:LocalizationManager.Instance}}" />
                                <Label Style="{StaticResource SettingsItemDescriptionStyle}" Text="Import plant data from a file" />
                            </VerticalStackLayout>
                            <Button
                                Grid.Column="1"
                                Padding="16,8"
                                Command="{Binding ImportDataCommand}"
                                FontSize="13"
                                HorizontalOptions="End"
                                Style="{StaticResource OutlineButtonStyle}"
                                Text="{Binding Path=[Import], Source={x:Static utils:LocalizationManager.Instance}}"
                                VerticalOptions="Center" />
                        </Grid>

                        <Grid Margin="0,4,0,0" ColumnDefinitions="Auto,*">
                            <CheckBox
                                HorizontalOptions="Start"
                                IsChecked="{Binding IsRemoveExistingData}"
                                VerticalOptions="Center" />
                            <Label
                                Grid.Column="1"
                                Style="{StaticResource SettingsItemDescriptionStyle}"
                                Text="{Binding Path=[RemoveExistingData], Source={x:Static utils:LocalizationManager.Instance}}"
                                VerticalOptions="Center" />
                        </Grid>
                    </VerticalStackLayout>
                </Border>

                <!--  Advanced Section  -->
                <Label Style="{StaticResource SettingsSectionHeaderStyle}" Text="{Binding Path=[AdvancedOptions], Source={x:Static utils:LocalizationManager.Instance}}" />

                <!--  Log Viewer  -->
                <Border Style="{StaticResource SettingsCardStyle}">
                    <Grid ColumnDefinitions="*,Auto">
                        <VerticalStackLayout VerticalOptions="Center">
                            <Label Style="{StaticResource SettingsItemLabelStyle}" Text="{Binding Path=[ShowLogs], Source={x:Static utils:LocalizationManager.Instance}}" />
                            <Label Style="{StaticResource SettingsItemDescriptionStyle}" Text="View application logs for troubleshooting" />
                        </VerticalStackLayout>
                        <Button
                            Grid.Column="1"
                            Padding="16,8"
                            Command="{Binding CheckLogsCommand}"
                            FontSize="13"
                            HorizontalOptions="End"
                            Style="{StaticResource OutlineButtonStyle}"
                            Text="{Binding Path=[ShowLogs], Source={x:Static utils:LocalizationManager.Instance}, FallbackValue='View'}"
                            VerticalOptions="Center" />
                    </Grid>
                </Border>

                <!--  Bottom spacing  -->
                <BoxView HeightRequest="20" Color="Transparent" />
            </VerticalStackLayout>
        </ScrollView>

        <components:LoadingOverlayView IsVisible="{Binding IsLoading}" />
    </Grid>
</views:ContentPageBase>
