<?xml version="1.0" encoding="utf-8" ?>

<views:ContentPageBase
    x:Class="PlantCare.App.Views.PlantDetailView"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:components="clr-namespace:PlantCare.App.Components"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    xmlns:utils="clr-namespace:PlantCare.App.Utils"
    xmlns:views="clr-namespace:PlantCare.App.Views"
    xmlns:vm="clr-namespace:PlantCare.App.ViewModels"
    Title="{Binding Name, StringFormat='{0}'}"
    x:DataType="vm:PlantDetailViewModel">
    <ContentPage.Resources>
        <ResourceDictionary>
            <utils:HoursToDayHourStringConverter x:Key="HoursToDayHourStringConverter" />
            <utils:ProgressToColorConverter x:Key="ProgressToColorConverter" />
            <toolkit:InvertedBoolConverter x:Key="InvertedBoolConverter" />
            
            <Style x:Key="ProgressIndicatorStyle" TargetType="ProgressBar">
                <Setter Property="HeightRequest" Value="6" />
                <Setter Property="ProgressColor" Value="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource Secondary}}" />
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid Padding="16,8,16,16">
        <ScrollView>
            <StackLayout Spacing="16">
                <!--  Photo Section with Edit Button  -->
                <Grid Margin="0,8,0,0">
                    <Border
                        HeightRequest="300"
                        HorizontalOptions="Center"
                        MaximumWidthRequest="300"
                        Stroke="{AppThemeBinding Light={StaticResource Gray200},
                                                 Dark={StaticResource Gray800}}"
                        StrokeThickness="2"
                        VerticalOptions="Center"
                        WidthRequest="300">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="150" />
                        </Border.StrokeShape>
                        <Border.Shadow>
                            <Shadow
                                Brush="Black"
                                Opacity="0.12"
                                Radius="16"
                                Offset="0,4" />
                        </Border.Shadow>

                        <Image
                            Aspect="AspectFill"
                            HorizontalOptions="Center"
                            MaximumHeightRequest="{OnIdiom Phone=300,
                                                           Tablet=400,
                                                           Default=300}"
                            Source="{Binding PhotoPath}"
                            VerticalOptions="Center" />
                    </Border>

                    <!--  Edit Button  -->
                    <Button
                        Margin="0,0,10,0"
                        Command="{Binding NavigateToEditPlantCommand}"
                        ContentLayout="Left,8"
                        CornerRadius="12"
                        HeightRequest="48"
                        HorizontalOptions="End"
                        Style="{StaticResource OutlineButtonStyle}"
                        Text="{Binding Path=[Edit], Source={x:Static utils:LocalizationManager.Instance}}"
                        VerticalOptions="End">
                        <Button.ImageSource>
                            <FontImageSource
                                FontFamily="MaterialIconsRegular"
                                Glyph="&#xe3c9;"
                                Size="24"
                                Color="{AppThemeBinding Light={StaticResource Gray900},
                                        Dark={StaticResource Gray200}}" />
                        </Button.ImageSource>
                    </Button>
                </Grid>

                <!--  Care Progress Status Card  -->
                <Border Padding="16" Style="{StaticResource ElevatedCardStyle}">
                    <VerticalStackLayout Spacing="12">
                        <!--  Card Title  -->
                        <Label
                            Style="{StaticResource TitleSmallStyle}"
                            Text="{Binding Path=[CareStatus], Source={x:Static utils:LocalizationManager.Instance}}"
                            HorizontalOptions="Center"
                            Margin="0,0,0,4" />
                        
                        <!--  Watering Progress  -->
                        <Grid ColumnDefinitions="auto,*" ColumnSpacing="12">
                            <Border
                                Padding="8"
                                BackgroundColor="{AppThemeBinding Light={StaticResource Gray100},
                                                                  Dark={StaticResource Gray800}}"
                                StrokeThickness="0">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="8" />
                                </Border.StrokeShape>
                                <Label
                                    FontFamily="MaterialIconsRegular"
                                    FontSize="20"
                                    Text="&#xe798;"
                                    TextColor="{Binding WaterState, Converter={StaticResource ProgressToColorConverter}}"
                                    VerticalOptions="Center" />
                            </Border>

                            <VerticalStackLayout Grid.Column="1" Spacing="4">
                                <Label
                                    Style="{StaticResource TitleSmallStyle}"
                                    Text="{Binding Path=[Watering], Source={x:Static utils:LocalizationManager.Instance}}"
                                    VerticalOptions="Center" />
                                <ProgressBar
                                    Progress="{Binding WaterState}"
                                    ProgressColor="{Binding WaterState, Converter={StaticResource ProgressToColorConverter}}"
                                    Style="{StaticResource ProgressIndicatorStyle}"
                                    VerticalOptions="Center" />
                            </VerticalStackLayout>
                        </Grid>

                        <!--  Fertilization Progress  -->
                        <Grid ColumnDefinitions="auto,*" ColumnSpacing="12">
                            <Border
                                Padding="8"
                                BackgroundColor="{AppThemeBinding Light={StaticResource Gray100},
                                                                  Dark={StaticResource Gray800}}"
                                StrokeThickness="0">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="8" />
                                </Border.StrokeShape>
                                <Label
                                    FontFamily="MaterialIconsRegular"
                                    FontSize="20"
                                    Text="&#xe761;"
                                    TextColor="{Binding FertilizeState, Converter={StaticResource ProgressToColorConverter}}"
                                    VerticalOptions="Center" />
                            </Border>

                            <VerticalStackLayout Grid.Column="1" Spacing="4">
                                <Label
                                    Style="{StaticResource TitleSmallStyle}"
                                    Text="{Binding Path=[Fertilization], Source={x:Static utils:LocalizationManager.Instance}}"
                                    VerticalOptions="Center" />
                                <ProgressBar
                                    Progress="{Binding FertilizeState}"
                                    ProgressColor="{Binding FertilizeState, Converter={StaticResource ProgressToColorConverter}}"
                                    Style="{StaticResource ProgressIndicatorStyle}"
                                    VerticalOptions="Center" />
                            </VerticalStackLayout>
                        </Grid>
                    </VerticalStackLayout>
                </Border>

                <!--  Basic Information Card  -->
                <Border Padding="16" Style="{StaticResource ModernCardStyle}">
                    <Grid
                        ColumnDefinitions="120,*"
                        ColumnSpacing="12"
                        RowDefinitions="auto,auto,auto,auto,auto,auto"
                        RowSpacing="12">

                        <!--  Species  -->
                        <Label
                            HorizontalTextAlignment="End"
                            Style="{StaticResource TitleSmallStyle}"
                            Text="{Binding Path=[Species], Source={x:Static utils:LocalizationManager.Instance}}"
                            VerticalOptions="Center" />
                        <Label
                            Grid.Column="1"
                            HorizontalOptions="Start"
                            Style="{StaticResource BodyStyle}"
                            Text="{Binding Species}"
                            VerticalOptions="Center" />

                        <!--  Age  -->
                        <Label
                            Grid.Row="1"
                            HorizontalTextAlignment="End"
                            Style="{StaticResource TitleSmallStyle}"
                            Text="{Binding Path=[Age], Source={x:Static utils:LocalizationManager.Instance}}"
                            VerticalOptions="Center" />
                        <Label
                            Grid.Row="1"
                            Grid.Column="1"
                            Style="{StaticResource BodyStyle}"
                            Text="{Binding Age}"
                            VerticalOptions="Center" />

                        <!--  LastWatered  -->
                        <Label
                            Grid.Row="2"
                            HorizontalTextAlignment="End"
                            Style="{StaticResource TitleSmallStyle}"
                            Text="{Binding Path=[LastWatering], Source={x:Static utils:LocalizationManager.Instance}}"
                            VerticalOptions="Center" />
                        <Label
                            Grid.Row="2"
                            Grid.Column="1"
                            Style="{StaticResource BodyStyle}"
                            Text="{Binding LastWatered, StringFormat='{0:MM/dd/yyyy HH:mm}'}"
                            VerticalOptions="Center" />

                        <!--  NextWatering  -->
                        <Label
                            Grid.Row="3"
                            HorizontalTextAlignment="End"
                            Style="{StaticResource TitleSmallStyle}"
                            Text="{Binding Path=[NextWatering], Source={x:Static utils:LocalizationManager.Instance}}"
                            VerticalOptions="Center" />
                        <Label
                            Grid.Row="3"
                            Grid.Column="1"
                            Style="{StaticResource BodyStyle}"
                            Text="{Binding NextWateringTime, StringFormat='{0:MM/dd/yyyy HH:mm}'}"
                            VerticalOptions="Center" />

                        <!--  LastFertilization  -->
                        <Label
                            Grid.Row="4"
                            HorizontalTextAlignment="End"
                            Style="{StaticResource TitleSmallStyle}"
                            Text="{Binding Path=[LastFertilization], Source={x:Static utils:LocalizationManager.Instance}}"
                            VerticalOptions="Center" />
                        <Label
                            Grid.Row="4"
                            Grid.Column="1"
                            Style="{StaticResource BodyStyle}"
                            Text="{Binding LastFertilized, StringFormat='{0:MM/dd/yyyy HH:mm}'}"
                            VerticalOptions="Center" />

                        <!--  NextFertilization  -->
                        <Label
                            Grid.Row="5"
                            HorizontalTextAlignment="End"
                            Style="{StaticResource TitleSmallStyle}"
                            Text="{Binding Path=[NextFertilization], Source={x:Static utils:LocalizationManager.Instance}}"
                            VerticalOptions="Center" />
                        <Label
                            Grid.Row="5"
                            Grid.Column="1"
                            Style="{StaticResource BodyStyle}"
                            Text="{Binding NextFertilizeTime, StringFormat='{0:MM/dd/yyyy HH:mm}'}"
                            VerticalOptions="Center" />
                    </Grid>
                </Border>

                <!--  Next Care Schedule Card  -->
                <Border Padding="16" Style="{StaticResource ElevatedCardStyle}">
                    <Grid
                        ColumnDefinitions="*,auto"
                        ColumnSpacing="12"
                        RowDefinitions="auto,auto"
                        RowSpacing="12">

                        <!--  Next watering  -->
                        <Label
                            HorizontalTextAlignment="End"
                            Style="{StaticResource TitleSmallStyle}"
                            Text="{Binding Path=[TillNextWatering], Source={x:Static utils:LocalizationManager.Instance}}"
                            TextColor="{StaticResource Primary}"
                            VerticalOptions="Center" />
                        <Label
                            Grid.Column="1"
                            HorizontalTextAlignment="Start"
                            Style="{StaticResource BodyStyle}"
                            Text="{Binding HoursUntilNextWatering, Converter={StaticResource HoursToDayHourStringConverter}}"
                            TextColor="{StaticResource Primary}"
                            VerticalOptions="Center" />

                        <!--  Next Fertilization  -->
                        <Label
                            Grid.Row="1"
                            HorizontalTextAlignment="End"
                            Style="{StaticResource TitleSmallStyle}"
                            Text="{Binding Path=[TillNextFertilization], Source={x:Static utils:LocalizationManager.Instance}}"
                            TextColor="{StaticResource Primary}"
                            VerticalOptions="Center" />
                        <Label
                            Grid.Row="1"
                            Grid.Column="1"
                            HorizontalOptions="Start"
                            HorizontalTextAlignment="Start"
                            Style="{StaticResource BodyStyle}"
                            Text="{Binding HoursUntilNextFertilize, Converter={StaticResource HoursToDayHourStringConverter}}"
                            TextColor="{StaticResource Primary}"
                            VerticalOptions="Center" />
                    </Grid>
                </Border>

                <!--  Notes Card  -->
                <Border Padding="12" Style="{StaticResource ModernCardStyle}">
                    <toolkit:Expander IsExpanded="True">
                        <toolkit:Expander.Header>
                            <Grid ColumnDefinitions="auto,*" ColumnSpacing="8">
                                <Label
                                    FontFamily="MaterialIconsRegular"
                                    Style="{StaticResource HeadlineSmallStyle}"
                                    Text="&#xe24d;"
                                    VerticalOptions="Center" />
                                <Label
                                    Grid.Column="1"
                                    Style="{StaticResource TitleSmallStyle}"
                                    Text="{Binding Path=[Notes], Source={x:Static utils:LocalizationManager.Instance}}"
                                    VerticalOptions="Center" />
                            </Grid>
                        </toolkit:Expander.Header>
                        <ScrollView
                            Margin="0,8,0,0"
                            MaximumHeightRequest="200"
                            VerticalScrollBarVisibility="Always">
                            <Label Style="{StaticResource BodyStyle}" Text="{Binding Notes}" />
                        </ScrollView>
                    </toolkit:Expander>
                </Border>

                <!--  Delete Button  -->
                <Button
                    Margin="0,8,0,16"
                    Command="{Binding DeletePlantCommand}"
                    HorizontalOptions="Center"
                    IsEnabled="{Binding IsBusy, Converter={StaticResource InvertedBoolConverter}}"
                    MinimumWidthRequest="200"
                    Style="{StaticResource DangerButtonStyle}"
                    Text="{Binding Path=[Delete], Source={x:Static utils:LocalizationManager.Instance}}" />
            </StackLayout>
        </ScrollView>

        <components:LoadingOverlayView IsVisible="{Binding IsLoading}" />
    </Grid>
</views:ContentPageBase>
